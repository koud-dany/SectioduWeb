{% extends "base.html" %}

{% block title %}Dashboard - SectionduWeb{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h2><i class="fas fa-tachometer-alt"></i> My Dashboard</h2>
                    <p class="text-muted">Welcome back, {{ session.username }}!</p>
                </div>
                <div>
                    <a href="{{ url_for('profile') }}" class="btn btn-outline-primary rounded-pill me-2">
                        <i class="fas fa-user me-1"></i>View Profile
                    </a>
                    <a href="{{ url_for('edit_profile') }}" class="btn btn-primary rounded-pill">
                        <i class="fas fa-edit me-1"></i>Edit Profile
                    </a>
                </div>
            </div>

        </div>
    </div>
    
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="stats-card text-center">
                <i class="fas fa-video fa-3x text-primary mb-3"></i>
                <h4>{{ user_videos|length }}</h4>
                <p class="text-muted">My Videos</p>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stats-card text-center">
                <i class="fas fa-star fa-3x text-warning mb-3"></i>
                <h4>{{ "%.1f"|format((user_videos|sum(attribute=4)/user_videos|length) if user_videos else 0) }}</h4>
                <p class="text-muted">Average Rating</p>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stats-card text-center">
                <i class="fas fa-thumbs-up fa-3x text-success mb-3"></i>
                <h4>{{ user_videos|sum(attribute=3) if user_videos else 0 }}</h4>
                <p class="text-muted">Total Votes</p>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-video"></i> My Videos</h5>
                    <a href="{{ url_for('upload_video') }}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Upload New Video
                    </a>
                </div>
                <div class="card-body">
                    {% if user_videos %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Upload Date</th>
                                    <th>Votes</th>
                                    <th>Rating</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for video in user_videos %}
                                <tr>
                                    <td>{{ video[1] }}</td>
                                    <td>{{ video[5] }}</td>
                                    <td>{{ video[3] }}</td>
                                    <td>
                                        <div class="rating-stars">
                                            {% for i in range(5) %}
                                            {% if i < video[4]|round %}
                                            <i class="fas fa-star"></i>
                                            {% else %}
                                            <i class="far fa-star"></i>
                                            {% endif %}
                                            {% endfor %}
                                            {{ "%.1f"|format(video[4] if video[4] is not none else 0.0) }}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <a href="{{ url_for('video_detail', video_id=video[0]) }}" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-eye"></i> View
                                            </a>
                                            {% if session.is_admin %}
                                            <div class="dropdown">
                                                <button class="btn btn-sm btn-outline-warning dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                                    <i class="fas fa-shield-alt"></i> Admin
                                                </button>
                                                <ul class="dropdown-menu">
                                                    <li><a class="dropdown-item" href="javascript:void(0)" onclick="toggleVideoFeature('{{ video[0] }}', '{{ video[1] }}')">
                                                        <i class="fas fa-star text-warning"></i> Toggle Feature
                                                    </a></li>
                                                    <li><a class="dropdown-item" href="javascript:void(0)" onclick="toggleVideoPin('{{ video[0] }}', '{{ video[1] }}')">
                                                        <i class="fas fa-thumbtack text-info"></i> Toggle Pin
                                                    </a></li>
                                                    <li><a class="dropdown-item" href="javascript:void(0)" onclick="toggleVideoVisibility('{{ video[0] }}', '{{ video[1] }}')">
                                                        <i class="fas fa-eye-slash text-secondary"></i> Toggle Visibility
                                                    </a></li>
                                                    <li><hr class="dropdown-divider"></li>
                                                    <li><a class="dropdown-item text-danger" href="javascript:void(0)" onclick="adminDeleteVideo('{{ video[0] }}', '{{ video[1] }}')">
                                                        <i class="fas fa-trash"></i> Admin Delete
                                                    </a></li>
                                                </ul>
                                            </div>
                                            {% endif %}
                                            <button type="button" class="btn btn-sm btn-outline-danger" data-video-id="{{ video[0] }}" data-video-title="{{ video[1] }}" onclick="confirmDeleteVideo(this)">
                                                <i class="fas fa-trash"></i> Delete
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-video fa-5x text-muted mb-4"></i>
                        <h4 class="text-muted">No videos uploaded yet</h4>
                        <p class="text-muted">Upload your first video to start competing!</p>
                        <a href="{{ url_for('upload_video') }}" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Upload Your First Video
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function confirmDeleteVideo(button) {
    const videoId = button.getAttribute('data-video-id');
    const videoTitle = button.getAttribute('data-video-title');
    
    if (confirm(`Are you sure you want to delete "${videoTitle}"?\n\nThis action cannot be undone. All votes and comments will also be deleted.`)) {
        // Create and submit form
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/delete_video/${videoId}`;
        
        // Add CSRF token if available
        const csrfToken = document.querySelector('meta[name="csrf-token"]');
        if (csrfToken) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrf_token';
            csrfInput.value = csrfToken.getAttribute('content');
            form.appendChild(csrfInput);
        }
        
        document.body.appendChild(form);
        form.submit();
    }
}

// ===== ADMIN FUNCTIONS =====

// Video Management Functions
function toggleVideoFeature(videoId, videoTitle) {
    fetch(`/admin/video/${videoId}/feature`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const action = data.featured ? 'featured' : 'unfeatured';
            showAdminToast(`"${videoTitle}" ${action} successfully`, 'success');
            // Update UI to reflect changes
            updateVideoStatusInTable(videoId, 'featured', data.featured);
        } else {
            showAdminToast(data.message || 'Failed to update video feature status', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAdminToast('Network error occurred', 'error');
    });
}

function toggleVideoPin(videoId, videoTitle) {
    fetch(`/admin/video/${videoId}/pin`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const action = data.pinned ? 'pinned' : 'unpinned';
            showAdminToast(`"${videoTitle}" ${action} successfully`, 'success');
            updateVideoStatusInTable(videoId, 'pinned', data.pinned);
        } else {
            showAdminToast(data.message || 'Failed to update video pin status', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAdminToast('Network error occurred', 'error');
    });
}

function toggleVideoVisibility(videoId, videoTitle) {
    fetch(`/admin/video/${videoId}/visibility`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const action = data.visible ? 'made visible' : 'hidden';
            showAdminToast(`"${videoTitle}" ${action} successfully`, 'success');
            updateVideoStatusInTable(videoId, 'visibility', data.visible);
        } else {
            showAdminToast(data.message || 'Failed to update video visibility', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAdminToast('Network error occurred', 'error');
    });
}

function adminDeleteVideo(videoId, videoTitle) {
    if (confirm(`⚠️ ADMIN DELETE ⚠️\n\nPermanently delete "${videoTitle}"?\n\nThis admin action cannot be undone and will remove:\n• The video file\n• All votes and ratings\n• All comments\n• View statistics\n\nConfirm deletion?`)) {
        fetch(`/admin/video/${videoId}/delete`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAdminToast(`"${videoTitle}" deleted successfully`, 'success');
                // Remove row from table with animation
                const row = document.querySelector(`button[data-video-id="${videoId}"]`).closest('tr');
                if (row) {
                    row.style.transition = 'all 0.3s ease';
                    row.style.opacity = '0';
                    row.style.transform = 'translateX(-100px)';
                    setTimeout(() => {
                        row.remove();
                        // Check if table is empty
                        const tbody = document.querySelector('tbody');
                        if (tbody && tbody.children.length === 0) {
                            location.reload(); // Reload to show empty state
                        }
                    }, 300);
                }
            } else {
                showAdminToast(data.message || 'Failed to delete video', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAdminToast('Network error occurred', 'error');
        });
    }
}

// Utility Functions
function updateVideoStatusInTable(videoId, statusType, isActive) {
    const row = document.querySelector(`button[data-video-id="${videoId}"]`).closest('tr');
    if (!row) return;

    // Remove existing status badges
    const existingBadges = row.querySelectorAll('.status-badge');
    existingBadges.forEach(badge => {
        if (badge.classList.contains(`${statusType}-badge`)) {
            badge.remove();
        }
    });

    // Add new status badge if active
    if (isActive) {
        const titleCell = row.querySelector('td:first-child');
        const badge = document.createElement('span');
        badge.className = `badge ms-2 status-badge ${statusType}-badge`;
        
        switch (statusType) {
            case 'featured':
                badge.classList.add('bg-warning');
                badge.innerHTML = '<i class="fas fa-star"></i> Featured';
                break;
            case 'pinned':
                badge.classList.add('bg-info');
                badge.innerHTML = '<i class="fas fa-thumbtack"></i> Pinned';
                break;
            case 'visibility':
                if (!isActive) { // Video is hidden
                    badge.classList.add('bg-secondary');
                    badge.innerHTML = '<i class="fas fa-eye-slash"></i> Hidden';
                }
                break;
        }
        
        if (badge.innerHTML) {
            titleCell.appendChild(badge);
        }
    }
}

function getCsrfToken() {
    const token = document.querySelector('meta[name="csrf-token"]');
    return token ? token.getAttribute('content') : '';
}

function showAdminToast(message, type = 'info') {
    // Create toast container if it doesn't exist
    let toastContainer = document.getElementById('admin-toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'admin-toast-container';
        toastContainer.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999;';
        document.body.appendChild(toastContainer);
    }

    // Create toast element
    const toast = document.createElement('div');
    toast.className = `alert alert-${getBootstrapClass(type)} alert-dismissible fade show admin-toast`;
    toast.style.cssText = 'margin-bottom: 10px; min-width: 300px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);';
    
    const icon = getToastIcon(type);
    toast.innerHTML = `
        <i class="${icon}"></i> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    toastContainer.appendChild(toast);

    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (toast.parentNode) {
            toast.classList.remove('show');
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 150);
        }
    }, 5000);
}

function getBootstrapClass(type) {
    const classMap = {
        'success': 'success',
        'error': 'danger',
        'warning': 'warning',
        'info': 'info'
    };
    return classMap[type] || 'info';
}

function getToastIcon(type) {
    const iconMap = {
        'success': 'fas fa-check-circle',
        'error': 'fas fa-exclamation-circle',
        'warning': 'fas fa-exclamation-triangle',
        'info': 'fas fa-info-circle'
    };
    return iconMap[type] || 'fas fa-info-circle';
}

// Dashboard-specific animations
document.addEventListener('DOMContentLoaded', function() {
    // Animate stats cards
    const statsCards = document.querySelectorAll('.stats-card');
    statsCards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            card.style.transition = 'all 0.5s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 100);
    });

    // Animate table rows
    const tableRows = document.querySelectorAll('tbody tr');
    tableRows.forEach((row, index) => {
        row.style.opacity = '0';
        row.style.transform = 'translateX(-20px)';
        
        setTimeout(() => {
            row.style.transition = 'all 0.4s ease';
            row.style.opacity = '1';
            row.style.transform = 'translateX(0)';
        }, (index * 100) + 300);
    });
});
</script>
{% endblock %}
