{% extends "base.html" %}

{% block title %}Join Video Tournament - SectionduWeb{% endblock %}

{% block content %}
<div class="container-fluid py-5" style="max-width: 1000px; margin: 0 auto;">
    <!-- Header -->
    <div class="text-center mb-5">
        <h1 class="display-4 fw-bold text-primary mb-3">
            <i class="fas fa-trophy text-warning me-3"></i>
            Join Video Tournament
        </h1>
        <p class="lead text-muted">Pay the one-time entry fee to participate in our exciting video tournament</p>
    </div>
    
    <!-- Tournament Entry -->
    <div class="row justify-content-center mb-5">
        <!-- Free Features -->
        <div class="col-lg-5">
            <div class="card h-100 border-0 shadow">
                <div class="card-header bg-light text-center py-4">
                    <h4 class="fw-bold">Free Account</h4>
                    <h2 class="text-success">$0<span class="fs-6 text-muted"> - No Payment Required</span></h2>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled">
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Watch all tournament videos</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Comment on videos</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Like/dislike videos</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Vote on tournament entries</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>View leaderboards</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Create profile</li>
                        <li class="mb-2"><i class="fas fa-times text-muted me-2"></i>Upload videos to tournament</li>
                    </ul>
                </div>
                <div class="card-footer bg-light text-center">
                    <button class="btn btn-outline-secondary rounded-pill px-4" disabled>
                        <i class="fas fa-user me-2"></i>Current Status
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Tournament Participant -->
        <div class="col-lg-5">
            <div class="card h-100 border-warning shadow-lg position-relative">
                <div class="position-absolute top-0 start-50 translate-middle">
                    <span class="badge bg-warning text-dark px-3 py-2 rounded-pill fw-bold">
                        <i class="fas fa-trophy me-1"></i>Tournament Entry
                    </span>
                </div>
                <div class="card-header bg-gradient text-white text-center py-4" style="background: linear-gradient(135deg, #ffd700, #ffb347);">
                    <h4 class="fw-bold text-dark">Tournament Participant</h4>
                    <h2 class="text-dark">$35<span class="fs-6 opacity-75"> - One-time Payment</span></h2>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <p class="text-muted">Everything in Free Account, PLUS:</p>
                    </div>
                    <ul class="list-unstyled">
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i><strong>Upload videos to tournament</strong></li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Compete for prizes and recognition</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>HD video quality uploads</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Enhanced profile features</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Tournament performance analytics</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Priority listing in leaderboards</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Unlimited video submissions</li>
                    </ul>
                </div>
                <div class="card-footer text-center" style="background: linear-gradient(135deg, #ffd700, #ffb347);">
                    <button class="btn btn-dark rounded-pill px-5 fw-bold py-2" id="upgrade-btn" onclick="initializePayment()">
                        <i class="fas fa-trophy me-2"></i>Join Tournament Now
                    </button>
                    
                    <!-- Stripe Payment Form (hidden by default) -->
                    <div id="payment-form" style="display: none;" class="mt-3">
                        <div id="card-element" class="form-control mb-3">
                            <!-- Stripe Elements will create form elements here -->
                        </div>
                        <button id="submit-payment" class="btn btn-success rounded-pill px-4">
                            <i class="fas fa-credit-card me-2"></i>Pay $35
                        </button>
                        <button id="cancel-payment" class="btn btn-outline-secondary rounded-pill px-4 ms-2" onclick="cancelPayment()">
                            Cancel
                        </button>
                        <div id="payment-errors" role="alert" class="text-danger mt-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tournament Information -->
    <div class="card shadow-sm border-0 mb-5">
        <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #667eea, #764ba2);">
            <h4 class="mb-0 text-center">
                <i class="fas fa-info-circle me-2"></i>
                Why Join the Tournament?
            </h4>
        </div>
        <div class="card-body">
            <div class="row g-4">
                <div class="col-md-4 text-center">
                    <div class="bg-primary bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;">
                        <i class="fas fa-trophy text-primary fa-2x"></i>
                    </div>
                    <h5>Compete for Prizes</h5>
                    <p class="text-muted">Show your creative skills and compete with other participants for amazing prizes and recognition.</p>
                </div>
                <div class="col-md-4 text-center">
                    <div class="bg-success bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;">
                        <i class="fas fa-users text-success fa-2x"></i>
                    </div>
                    <h5>Build Your Audience</h5>
                    <p class="text-muted">Get your videos seen by thousands of viewers and build a following in our active community.</p>
                </div>
                <div class="col-md-4 text-center">
                    <div class="bg-warning bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;">
                        <i class="fas fa-star text-warning fa-2x"></i>
                    </div>
                    <h5>Gain Recognition</h5>
                    <p class="text-muted">Top performers are featured on our leaderboards and get special recognition badges.</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- FAQ -->
    <div class="card shadow-sm border-0">
        <div class="card-header bg-light">
            <h4 class="mb-0">
                <i class="fas fa-question-circle text-info me-2"></i>
                Frequently Asked Questions
            </h4>
        </div>
        <div class="card-body">
            <div class="accordion" id="faqAccordion">
                <div class="accordion-item border-0 mb-3">
                    <h2 class="accordion-header">
                        <button class="accordion-button bg-light" type="button" data-bs-toggle="collapse" data-bs-target="#faq1">
                            Is this a one-time payment or recurring subscription?
                        </button>
                    </h2>
                    <div id="faq1" class="accordion-collapse collapse show" data-bs-parent="#faqAccordion">
                        <div class="accordion-body">
                            This is a <strong>one-time payment of $35</strong> to join the video tournament. There are no recurring charges or monthly fees. Once you pay, you can participate in the tournament indefinitely.
                        </div>
                    </div>
                </div>
                
                <div class="accordion-item border-0 mb-3">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed bg-light" type="button" data-bs-toggle="collapse" data-bs-target="#faq2">
                            What can I do with a free account?
                        </button>
                    </h2>
                    <div id="faq2" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                        <div class="accordion-body">
                            With a free account, you can watch all tournament videos, comment, like/dislike, vote on submissions, view leaderboards, and create your profile. You just cannot upload videos to compete in the tournament.
                        </div>
                    </div>
                </div>
                
                <div class="accordion-item border-0">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed bg-light" type="button" data-bs-toggle="collapse" data-bs-target="#faq3">
                            How many videos can I upload after paying?
                        </button>
                    </h2>
                    <div id="faq3" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                        <div class="accordion-body">
                            There's no limit! Once you pay the $35 tournament entry fee, you can upload unlimited videos to compete in the tournament. All uploads are in HD quality.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Stripe JavaScript -->
<script src="https://js.stripe.com/v3/"></script>
<script>
// Initialize Stripe - Get key from Flask config
const stripePublishableKey = '{{ config.STRIPE_PUBLISHABLE_KEY }}';
console.log('Stripe key loaded:', stripePublishableKey ? 'Key present' : 'Key missing');

if (!stripePublishableKey || stripePublishableKey === '') {
    console.error('Stripe publishable key is missing!');
    alert('Payment system configuration error. Please contact support.');
}

const stripe = Stripe(stripePublishableKey);
const elements = stripe.elements();

// Create an instance of the card Element
const cardElement = elements.create('card', {
    style: {
        base: {
            fontSize: '16px',
            color: '#424770',
            '::placeholder': {
                color: '#aab7c4',
            },
        },
    },
});

let paymentFormMounted = false;

function initializePayment() {
    const paymentForm = document.getElementById('payment-form');
    const upgradeBtn = document.getElementById('upgrade-btn');
    
    paymentForm.style.display = 'block';
    upgradeBtn.style.display = 'none';
    
    if (!paymentFormMounted) {
        cardElement.mount('#card-element');
        paymentFormMounted = true;
    }
    
    setupPaymentHandler();
}

function cancelPayment() {
    const paymentForm = document.getElementById('payment-form');
    const upgradeBtn = document.getElementById('upgrade-btn');
    
    paymentForm.style.display = 'none';
    upgradeBtn.style.display = 'block';
}

function setupPaymentHandler() {
    const submitButton = document.getElementById('submit-payment');
    const errorElement = document.getElementById('payment-errors');
    
    submitButton.addEventListener('click', async function(event) {
        event.preventDefault();
        
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
        
        // Create payment intent
        try {
            const response = await fetch('/create_payment_intent', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to create payment intent');
            }
            
            const responseData = await response.json();
            console.log('Payment intent response:', responseData);
            
            if (!responseData.client_secret) {
                throw new Error('No client secret received from server');
            }
            
            const { client_secret } = responseData;
            
            // Confirm payment with Stripe
            const { error, paymentIntent } = await stripe.confirmCardPayment(client_secret, {
                payment_method: {
                    card: cardElement,
                }
            });
            
            if (error) {
                errorElement.textContent = error.message;
                submitButton.disabled = false;
                submitButton.innerHTML = '<i class="fas fa-credit-card me-2"></i>Pay $35';
            } else {
                // Payment succeeded, confirm with server
                const confirmResponse = await fetch('/confirm_payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        payment_intent_id: paymentIntent.id
                    })
                });
                
                const result = await confirmResponse.json();
                
                if (result.success) {
                    alert('Payment successful! You can now upload videos.');
                    window.location.href = '/upload_video';
                } else {
                    errorElement.textContent = result.message || 'Payment verification failed';
                    submitButton.disabled = false;
                    submitButton.innerHTML = '<i class="fas fa-credit-card me-2"></i>Pay $35';
                }
            }
        } catch (err) {
            errorElement.textContent = 'An error occurred: ' + err.message;
            submitButton.disabled = false;
            submitButton.innerHTML = '<i class="fas fa-credit-card me-2"></i>Pay $35';
        }
    });
}

// Tournament entry payment completed successfully

// Animate pricing cards on load
document.addEventListener('DOMContentLoaded', function() {
    const cards = document.querySelectorAll('.card');
    cards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            card.style.transition = 'all 0.6s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 150);
    });
});
</script>
{% endblock %}