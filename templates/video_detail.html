{% extends "base.html" %}

{% block title %}{{ video[2] }} - SectionduWeb{% endblock %}

{% block content %}
<style>
/* Fix for thumbs up icon visibility */
.like-btn i, .dislike-btn i {
    display: inline-block !important;
    opacity: 1 !important;
    visibility: visible !important;
    font-weight: normal !important;
    min-width: 16px;
    text-align: center;
}

.like-btn:hover i, .dislike-btn:hover i {
    transform: scale(1.1);
    transition: transform 0.2s ease;
}

/* Ensure proper icon states */
.like-btn[data-liked="true"] i {
    color: #0d6efd !important;
    font-weight: 900 !important;
}

.dislike-btn[data-disliked="true"] i {
    color: #dc3545 !important;
    font-weight: 900 !important;
}

.like-btn[data-liked="true"] {
    border-color: #0d6efd !important;
}

.dislike-btn[data-disliked="true"] {
    border-color: #dc3545 !important;
}

/* Comment action buttons styling */
.comment-actions .btn {
    border: 1px solid #dee2e6;
    background: transparent;
    transition: all 0.2s ease;
}

.comment-actions .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* YouTube-style video info styling */
.video-title {
    font-size: 1.25rem;
    font-weight: 600;
    line-height: 1.3;
    margin-bottom: 0.75rem;
}

.video-stats {
    font-size: 0.9rem;
    color: #606060;
}

.channel-info {
    border-bottom: 1px solid #e0e0e0;
    padding-bottom: 1rem;
    margin-bottom: 1rem;
}

.description-section {
    background-color: #f9f9f9;
    border-radius: 12px;
    padding: 1rem;
    font-size: 0.9rem;
    line-height: 1.5;
}

/* Animation for toast notifications */
@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOutRight {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}

/* Star Rating Styles */
.star-rating {
    display: flex;
    gap: 0.25rem;
    font-size: 1.5rem;
}

.star-rating .star {
    color: #ddd;
    cursor: pointer;
    transition: all 0.2s ease;
    transform: scale(1);
}

.star-rating .star:hover {
    transform: scale(1.1);
    color: #ffc107;
}

.star-rating .star.active {
    color: #ffc107;
}

.star-rating .star.filled {
    color: #ffc107;
}

.rating-container {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 12px;
    padding: 1rem;
    border: 1px solid #e0e6ed;
}

.rating-text {
    font-weight: 500;
    color: #495057;
}

.current-rating .average-stars {
    font-size: 1.1rem;
}

.current-rating .average-stars i {
    margin-right: 2px;
}

/* Rating animation effects */
@keyframes starPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
}

.star-rating .star.animate {
    animation: starPulse 0.3s ease;
}

/* Rating success animation */
@keyframes ratingSuccess {
    0% {
        background: #f8f9fa;
        border-color: #e0e6ed;
    }
    50% {
        background: #d4edda;
        border-color: #28a745;
    }
    100% {
        background: #f8f9fa;
        border-color: #e0e6ed;
    }
}

.rating-container.success {
    animation: ratingSuccess 1s ease;
}
</style>

<div class="container-fluid py-4" style="max-width: 1280px; margin: 0 auto;">
    <div class="row g-4">
        <!-- Main Video Content (YouTube-style main column) -->
        <div class="col-lg-8 col-xl-9" style="padding-left: clamp(12px, 3vw, 24px); padding-right: clamp(12px, 3vw, 24px);">
            <!-- YouTube-Style Video Player -->
            <div class="mb-3">
                <div class="position-relative video-container" style="aspect-ratio: 16/9; max-width: 100%; background: #000; border-radius: 12px; overflow: hidden;">
                    <video class="w-100 h-100 shadow-lg" controls preload="metadata" style="object-fit: contain; border-radius: 12px;">
                        <source src="{{ get_video_url(video[4]) }}" type="video/mp4">
                        <source src="{{ get_video_url(video[4]) }}" type="video/webm">
                        <source src="{{ get_video_url(video[4]) }}" type="video/ogg">
                        <p class="text-center text-muted mt-3">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Your browser does not support the video tag or the video format.
                            <br><small>Supported formats: MP4, WebM, OGG</small>
                        </p>
                    </video>
                    <!-- Video overlay for better visual appeal (only shows when paused) -->
                    <div class="video-overlay position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center" style="border-radius: 12px; background: rgba(0,0,0,0.3); opacity: 0; transition: opacity 0.3s; pointer-events: none;">
                        <i class="fas fa-play-circle text-white" style="font-size: 3rem;"></i>
                    </div>
                </div>
            </div>
            
            <!-- Enhanced Video Info Card (YouTube-style) -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-body p-4">
                    <!-- Video Title (YouTube-style) -->
                    <h1 class="h3 fw-bold mb-3 text-dark">{{ video[2] }}</h1>
                    
                    <!-- Video Stats and Actions Row -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="d-flex align-items-center gap-3">
                            <span class="text-muted">
                                <i class="fas fa-eye me-1"></i>{{ video[14] if video[14] else 0 }} views
                                {% if not session.user_id %}
                                <small class="text-muted ms-2" title="Sign in to contribute to view counts">
                                    <i class="fas fa-info-circle"></i>
                                </small>
                                {% endif %}
                            </span>
                            <span class="text-muted">â€¢</span>
                            <span class="text-muted">{{ video[5] }}</span>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-thumbs-up text-primary me-2" style="font-size: 1.1rem;"></i>
                                <span class="fw-bold text-primary">{{ video[6] if video[6] is not none else 0 }} votes</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Channel Info (YouTube-style) -->
                    <div class="d-flex align-items-center mb-3 pb-3 border-bottom">
                        <div class="d-flex align-items-center flex-grow-1">
                            <div class="position-relative me-3">
                                {% if video[-1] %}
                                <img src="{{ url_for('static', filename='avatars/' + video[-1]) }}" 
                                     alt="{{ video[-2] }}'s Avatar" 
                                     class="rounded-circle shadow"
                                     style="width: 48px; height: 48px; object-fit: cover;">
                                {% else %}
                                <div class="bg-gradient bg-primary rounded-circle d-flex align-items-center justify-content-center shadow" 
                                     style="width: 48px; height: 48px;">
                                    <i class="fas fa-user text-white"></i>
                                </div>
                                {% endif %}
                                <span class="position-absolute bottom-0 end-0 bg-success rounded-circle border border-2 border-white" 
                                      style="width: 16px; height: 16px;" title="Verified Creator">
                                </span>
                            </div>
                            <div>
                                <h6 class="mb-0 fw-semibold">
                                    <a href="{{ url_for('profile', username=video[-2]) }}" class="text-decoration-none text-dark">
                                        {{ video[-2] }}
                                    </a>
                                </h6>
                                <small class="text-muted">Content Creator</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Description Section (YouTube-style expandable) -->
                    {% if video[3] %}
                    <div class="bg-light rounded-3 p-3">
                        <div class="description-content">
                            <p class="mb-2 lh-base">{{ video[3][:200] }}{% if video[3]|length > 200 %}...{% endif %}</p>
                            {% if video[3]|length > 200 %}
                            <button class="btn btn-link p-0 text-decoration-none fw-semibold" onclick="expandDescription()">
                                <span data-i18n="common.showMore">{{ translations.common.showMore if translations.common else 'Show more' }}</span>
                            </button>
                            {% endif %}
                        </div>
                        <div class="description-full d-none">
                            <p class="mb-2 lh-base">{{ video[3] }}</p>
                            <button class="btn btn-link p-0 text-decoration-none fw-semibold" onclick="collapseDescription()">
                                <span data-i18n="common.showLess">{{ translations.common.showLess if translations.common else 'Show less' }}</span>
                            </button>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Star Rating Section -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-body p-4">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-star text-warning me-2"></i><span data-i18n="video.rateThisVideo">{{ translations.video.rateThisVideo if translations.video else 'Rate this Video' }}</span>
                    </h5>
                    
                    {% if session.user_id %}
                        <div class="rating-container">
                            <div class="d-flex align-items-center mb-3">
                                <div class="star-rating me-3" data-video-id="{{ video[0] }}">
                                    <i class="fas fa-star star" data-rating="1"></i>
                                    <i class="fas fa-star star" data-rating="2"></i>
                                    <i class="fas fa-star star" data-rating="3"></i>
                                    <i class="fas fa-star star" data-rating="4"></i>
                                    <i class="fas fa-star star" data-rating="5"></i>
                                </div>
                                <div class="rating-text">
                                    <span id="rating-message">Click a star to rate</span>
                                </div>
                            </div>
                            
                            <!-- Current Rating Display -->
                            {% if video[7] and video[7] > 0 %}
                            <div class="current-rating mb-3">
                                <div class="d-flex align-items-center">
                                    <div class="average-stars me-3">
                                        {% set avg_rating = video[7] %}
                                        {% for i in range(1, 6) %}
                                            {% if i <= avg_rating %}
                                                <i class="fas fa-star text-warning"></i>
                                            {% elif i - 0.5 <= avg_rating %}
                                                <i class="fas fa-star-half-alt text-warning"></i>
                                            {% else %}
                                                <i class="far fa-star text-muted"></i>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                    <span class="text-muted">
                                        {{ "%.1f"|format(video[7]) }} out of 5 
                                        <small>({{ video[6] if video[6] else 0 }} ratings)</small>
                                    </span>
                                </div>
                            </div>
                            {% else %}
                            <div class="current-rating mb-3">
                                <div class="d-flex align-items-center">
                                    <div class="average-stars me-3">
                                        <i class="far fa-star text-muted"></i>
                                        <i class="far fa-star text-muted"></i>
                                        <i class="far fa-star text-muted"></i>
                                        <i class="far fa-star text-muted"></i>
                                        <i class="far fa-star text-muted"></i>
                                    </div>
                                    <span class="text-muted" data-i18n="video.noRatingsYet">{{ translations.video.noRatingsYet if translations.video else 'No ratings yet - be the first!' }}</span>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    {% else %}
                        <div class="text-center py-3">
                            <i class="fas fa-sign-in-alt fa-2x text-muted mb-2"></i>
                            <p class="text-muted mb-3" data-i18n="rating.signInToRate">{{ translations.rating.signInToRate if translations.rating else 'Please sign in to rate this video' }}</p>
                            <a href="{{ url_for('login') }}" class="btn btn-primary">
                                <i class="fas fa-sign-in-alt me-2"></i><span data-i18n="auth.signIn">{{ translations.auth.signIn if translations.auth else 'Sign In' }}</span>
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- PHONE VOTING SECTION - Compact Hero Style -->
            <div class="card shadow-lg border-0 mt-4 mb-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px; overflow: hidden;">
                <div class="card-body p-4">
                    <div class="row align-items-center g-3">
                        <!-- Left: Icon & Title -->
                        <div class="col-lg-4">
                            <div class="d-flex align-items-center gap-3 text-white">
                                <div class="phone-icon-wrapper" style="background: rgba(255,255,255,0.2); border-radius: 50%; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                    <i class="fas fa-phone-alt" style="font-size: 1.5rem; color: #FFD700; animation: pulse 2s infinite;"></i>
                                </div>
                                <div>
                                    <h5 class="mb-1 fw-bold" data-i18n="video.voteByPhoneTitle">{{ translations.video.voteByPhoneTitle if translations.video else 'Vote by Phone!' }}</h5>
                                    <small class="text-white-50" data-i18n="video.noAccountRequiredShort">{{ translations.video.noAccountRequiredShort if translations.video else 'No account needed' }}</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Center: Phone Number (Clickable) -->
                        <div class="col-lg-4">
                            <a href="tel:+2425537224" onclick="copyVideoPhoneNumberAuto(event)" class="text-decoration-none d-block">
                                <div style="background: rgba(255,255,255,0.95); padding: 1rem 1.5rem; border-radius: 12px; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.2); text-align: center;">
                                    <div class="d-flex align-items-center justify-content-center gap-2">
                                        <i class="fas fa-phone" style="color: #667eea; font-size: 1.2rem;"></i>
                                        <div>
                                            <div class="text-dark fw-bold" style="font-size: 1.2rem; letter-spacing: 1px; line-height: 1.2;">+242 55 37 22 4</div>
                                            <small class="text-muted" style="font-size: 0.7rem;">
                                                <i class="fas fa-copy me-1"></i><span data-i18n="video.tapToCallAndCopy">{{ translations.video.tapToCallAndCopy if translations.video else 'Tap & auto-copy' }}</span>
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </a>
                        </div>
                        
                        <!-- Right: Video Info & Hours -->
                        <div class="col-lg-4">
                            <div class="text-white">
                                <div class="mb-2" style="background: rgba(255,255,255,0.15); padding: 0.5rem; border-radius: 8px; backdrop-filter: blur(5px);">
                                    <small class="fw-semibold">
                                        <i class="fas fa-video me-1"></i>
                                        <span data-i18n="video.mentionVideoShort">{{ translations.video.mentionVideoShort if translations.video else 'Mention' }}</span>: "{{ video[2][:25] }}{% if video[2]|length > 25 %}...{% endif %}"
                                    </small>
                                </div>
                                <div style="background: rgba(255,255,255,0.15); padding: 0.5rem; border-radius: 8px; backdrop-filter: blur(5px);">
                                    <small class="fw-semibold">
                                        <i class="fas fa-clock me-1"></i>
                                        8:00 AM - 10:00 PM
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Enhanced Comments Section -->
            <div class="card shadow-sm border-0 mt-4">
                <div class="card-header bg-gradient bg-primary text-white border-0 py-3">
                    <h5 class="mb-0">
                        <i class="fas fa-comments me-2"></i>
                        <span data-i18n="comments.comments">{{ translations.comments.comments if translations.comments else 'Comments' }}</span> 
                        <span class="badge bg-light text-dark ms-2">{{ comments|length }}</span>
                    </h5>
                </div>
                <div class="card-body p-4">
                    {% if session.user_id %}
                    <!-- YouTube-Style Comment Form -->
                    <form id="main-comment-form" class="mb-4">
                        <div class="d-flex">
                            <div class="me-3">
                                {% if current_user_avatar %}
                                <img src="{{ url_for('static', filename='avatars/' + current_user_avatar) }}" 
                                     alt="Your Avatar" 
                                     class="rounded-circle shadow-sm border border-2 border-light"
                                     style="width: 40px; height: 40px; object-fit: cover;">
                                {% else %}
                                <div class="bg-success rounded-circle d-flex align-items-center justify-content-center shadow-sm border border-2 border-light" 
                                     style="width: 40px; height: 40px;">
                                    <i class="fas fa-user text-white"></i>
                                </div>
                                {% endif %}
                            </div>
                            <div class="flex-grow-1">
                                <textarea class="form-control border-0 border-bottom rounded-0" id="main-comment-input" 
                                          rows="1" placeholder="{{ translations.comments.addComment if translations.comments else 'Add a comment...' }}" required
                                          style="resize: none; box-shadow: none;"></textarea>
                                <div class="d-flex justify-content-between align-items-center mt-2 d-none" id="comment-actions">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Be respectful and constructive
                                    </small>
                                    <div class="gap-2 d-flex">
                                        <button type="button" class="btn btn-sm btn-outline-secondary" id="cancel-comment">Cancel</button>
                                        <button type="submit" class="btn btn-sm btn-primary" id="submit-comment" data-video-id="{{ video[0] }}" disabled>
                                            <i class="fas fa-paper-plane me-1"></i>Comment
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                    <hr class="my-4">
                    {% endif %}
                    
                    <!-- YouTube-Style Comments -->
                    <div class="comment-section" id="comments-container">
                        {% for comment in comments %}
                        <div class="comment-thread mb-4" data-comment-id="{{ comment.id }}">
                            <!-- Main Comment -->
                            <div class="d-flex comment-item">
                                <div class="flex-shrink-0 me-3">
                                    {% if comment.avatar %}
                                    <img src="{{ url_for('static', filename='avatars/' + comment.avatar) }}" 
                                         alt="{{ comment.username }}'s Avatar" 
                                         class="rounded-circle shadow-sm border border-2 border-light"
                                         style="width: 40px; height: 40px; object-fit: cover;">
                                    {% else %}
                                    <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center shadow-sm border border-2 border-light" 
                                         style="width: 40px; height: 40px;">
                                        <i class="fas fa-user text-white"></i>
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center mb-1">
                                        <h6 class="mb-0 me-2">
                                            <a href="{{ url_for('profile', username=comment.username) }}" class="text-decoration-none text-dark">
                                                {{ comment.username }}
                                            </a>
                                        </h6>
                                        <small class="text-muted">{{ comment.date }}</small>
                                    </div>
                                    <p class="mb-2">{{ comment.text }}</p>
                                    
                                    <!-- Comment Actions (YouTube-style) -->
                                    <div class="comment-actions d-flex align-items-center gap-3">
                                        <button class="btn btn-sm btn-outline-secondary like-btn" data-comment-id="{{ comment.id }}" data-liked="{{ 'true' if comment.user_liked else 'false' }}" title="Like">
                                            <i class="{% if comment.user_liked %}fas fa-thumbs-up{% else %}far fa-thumbs-up{% endif %} me-1"></i>
                                            <span class="like-count">{{ comment.like_count }}</span>
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary dislike-btn" data-comment-id="{{ comment.id }}" data-disliked="{{ 'true' if comment.user_disliked else 'false' }}" title="Dislike">
                                            <i class="{% if comment.user_disliked %}fas fa-thumbs-down{% else %}far fa-thumbs-down{% endif %}"></i>
                                        </button>
                                        {% if session.user_id %}
                                        <button class="btn btn-sm btn-link text-muted reply-btn" data-comment-id="{{ comment.id }}">
                                            <i class="fas fa-reply me-1"></i>Reply
                                        </button>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Show Replies Button (YouTube-style) -->
                                    {% if comment.reply_count > 0 %}
                                    <div class="show-replies-btn mt-2" data-comment-id="{{ comment.id }}">
                                        <button class="btn btn-sm btn-link text-primary fw-bold p-0 toggle-replies d-flex align-items-center" data-comment-id="{{ comment.id }}" data-expanded="false" style="text-decoration: none;">
                                            <i class="fas fa-chevron-down me-2"></i>
                                            <span class="reply-count-text">{{ comment.reply_count }} replies</span>
                                        </button>
                                    </div>
                                    {% endif %}
                                    
                                    <!-- Reply Form (Hidden by default) -->
                                    {% if session.user_id %}
                                    <div class="reply-form mt-3" style="display: none;" data-comment-id="{{ comment.id }}">
                                        <div class="d-flex">
                                            <div class="me-2">
                                                <div class="bg-success rounded-circle d-flex align-items-center justify-content-center" 
                                                     style="width: 32px; height: 32px;">
                                                    <i class="fas fa-user text-white" style="font-size: 0.8rem;"></i>
                                                </div>
                                            </div>
                                            <div class="flex-grow-1">
                                                <textarea class="form-control border-0 border-bottom rounded-0 reply-input" 
                                                          rows="2" placeholder="Add a reply..."></textarea>
                                                <div class="d-flex justify-content-end mt-2 gap-2">
                                                    <button class="btn btn-sm btn-outline-secondary cancel-reply">Cancel</button>
                                                    <button class="btn btn-sm btn-primary submit-reply" data-video-id="{{ video[0] }}" data-parent-id="{{ comment.id }}">Reply</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                    
                                    <!-- Replies Container (Initially hidden) -->
                                    <div class="replies-container mt-3" data-comment-id="{{ comment.id }}" style="display: none;">
                                        <!-- Replies will be loaded here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        
                        {% if not comments %}
                        <div class="text-center py-5" id="no-comments">
                            <i class="fas fa-comment-slash text-muted display-4 mb-3"></i>
                            <h6 class="text-muted" data-i18n="comments.noCommentsYet">{{ translations.comments.noCommentsYet if translations.comments else 'No comments yet' }}</h6>
                            <p class="text-muted" data-i18n="comments.beTheFirst">{{ translations.comments.beTheFirst if translations.comments else 'Be the first to share your thoughts about this video!' }}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Enhanced Voting Section -->
            {% if session.user_id %}
            <div class="card shadow-sm border-0 bg-primary bg-opacity-10 border-primary border-opacity-25 mb-4">
                <div class="card-body p-4 text-center">
                    <h5 class="card-title text-primary mb-3">
                        <i class="fas fa-thumbs-up me-2"></i><span data-i18n="video.castYourVote">{{ translations.video.castYourVote if translations.video else 'Cast Your Vote' }}</span>
                    </h5>
                    <p class="text-muted mb-3"><span data-i18n="video.supportVideo">{{ translations.video.supportVideo if translations.video else 'Support this video by casting your vote!' }}</span> <strong>(<span data-i18n="video.votingFeeRequired">{{ translations.video.votingFeeRequired if translations.video else '$2 voting fee required' }}</span>)</strong></p>
                    <button id="voteBtn" class="btn btn-primary btn-lg px-5 py-3" data-video-id="{{ video[0] }}">
                        <i class="fas fa-vote-yea me-2"></i><span data-i18n="video.voteForThisVideo">{{ translations.video.voteForThisVideo if translations.video else 'Vote for This Video' }}</span>
                    </button>
                    <small class="text-muted d-block mt-2">
                        <i class="fas fa-info-circle me-1"></i><span data-i18n="video.votingFeeNote">{{ translations.video.votingFeeNote if translations.video else '$2 fee required per video vote' }}</span>
                    </small>
                </div>
            </div>
            {% else %}
            <div class="alert alert-info border-0 rounded-3 mb-3">
                <h6 class="alert-heading">
                    <i class="fas fa-sign-in-alt me-2"></i><span data-i18n="video.joinCommunity">{{ translations.video.joinCommunity if translations.video else 'Join the Community' }}</span>
                </h6>
                <p class="mb-2" data-i18n="video.signInToVote">{{ translations.video.signInToVote if translations.video else 'Sign in to vote for videos and join the tournament!' }}</p>
                <a href="{{ url_for('login') }}" class="btn btn-primary btn-sm">
                    <i class="fas fa-user-plus me-1"></i><span data-i18n="auth.signIn">{{ translations.auth.signIn if translations.auth else 'Sign In' }}</span>
                </a>
            </div>
            
            <!-- Phone Voting Option for Non-Registered Users -->
            <div class="card phone-voting-card shadow-lg border-0 mb-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 15px; overflow: hidden;">
                <div class="card-body p-4 text-center position-relative">
                    <!-- Background Animation -->
                    <div class="phone-bg-animation" style="position: absolute; top: -50px; left: -50px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%; opacity: 0;"></div>
                    
                    <div class="phone-voting-content position-relative z-index-1">
                        <h5 class="card-title mb-3" style="font-weight: 700;">
                            <i class="fas fa-phone-alt me-2 phone-icon" style="color: #FFD700; animation: pulse 2s infinite;"></i>
                            <span data-i18n="video.voteByPhone">{{ translations.video.voteByPhone if translations.video else 'Vote by Phone Call' }}</span>
                        </h5>
                        <p class="mb-3" style="color: rgba(255,255,255,0.9); font-size: 0.95rem;">
                            <span data-i18n="video.noAccountNeeded">{{ translations.video.noAccountNeeded if translations.video else 'No account needed! Call our organizers directly to cast your vote for this video.' }}</span>
                        </p>
                        
                        <div class="phone-number-container mb-4">
                            <div class="phone-number-display" onclick="copyVideoPhoneNumber()" style="cursor: pointer; transition: all 0.3s ease; padding: 12px 16px; border-radius: 10px; background: rgba(255,255,255,0.15); border: 2px solid rgba(255,255,255,0.3); backdrop-filter: blur(10px);">
                                <a href="tel:+2425537224" class="phone-number mb-2 text-decoration-none" style="font-size: 1.3rem; font-weight: 700; color: #ffffff; text-shadow: 0 2px 6px rgba(0,0,0,0.4); letter-spacing: 1px; font-family: 'Segoe UI', sans-serif; display: block;">
                                    +242 55 37 22 4
                                </a>
                                <div class="copy-hint" style="font-size: 0.7rem; color: rgba(255,255,255,0.8);">
                                    <i class="fas fa-copy me-1"></i><span data-i18n="video.tapToCopy">{{ translations.video.tapToCopy if translations.video else 'Tap to copy or call directly' }}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="voting-instructions">
                            <div class="row text-center">
                                <div class="col-12 mb-2">
                                    <small style="color: rgba(255,255,255,0.8); font-size: 0.85rem;">
                                        <i class="fas fa-clock me-1"></i>
                                        <strong><span data-i18n="video.available">{{ translations.video.available if translations.video else 'Available' }}</span>: 8:00 AM - 10:00 PM</strong>
                                    </small>
                                </div>
                                <div class="col-12">
                                    <small style="color: rgba(255,255,255,0.7); font-size: 0.8rem;">
                                        <i class="fas fa-info-circle me-1"></i>
                                        <span data-i18n="video.mentionVideo">{{ translations.video.mentionVideo if translations.video else 'Mention video' }}</span>: "{{ video[2][:30] }}{% if video[2]|length > 30 %}...{% endif %}"
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="phone-action-buttons mt-3">
                            <a href="tel:+2425537224" class="btn btn-outline-light btn-sm me-2" style="border-radius: 20px; border: 2px solid rgba(255,255,255,0.5);">
                                <i class="fas fa-phone me-1"></i><span data-i18n="video.callNow">{{ translations.video.callNow if translations.video else 'Call Now' }}</span>
                            </a>
                            <button onclick="shareVideoForVoting()" class="btn btn-outline-warning btn-sm" style="border-radius: 20px; border: 2px solid rgba(255,215,0,0.5); color: #FFD700;">
                                <i class="fas fa-share me-1"></i><span data-i18n="video.shareVideo">{{ translations.video.shareVideo if translations.video else 'Share Video' }}</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Enhanced YouTube-Style Sidebar -->
        <div class="col-lg-4 col-xl-3" style="padding-left: clamp(12px, 2vw, 24px); padding-right: clamp(12px, 2vw, 24px);">
            <div class="sticky-top sidebar-scroll" style="top: 80px; z-index: 1020;">
                <!-- Top Videos - Enhanced Card -->
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-header bg-gradient bg-primary text-white border-0 py-3">
                        <h6 class="mb-0 fw-bold">
                            <i class="fas fa-trophy me-2"></i><span data-i18n="leaderboard.topVideos">{{ translations.leaderboard.topVideos if translations.leaderboard else 'Top Videos' }}</span>
                        </h6>
                    </div>
                    <div class="card-body p-3">
                    
                    {% if top_videos %}
                    <div class="d-grid gap-2">
                        {% for top_video in top_videos %}
                        {% if top_video[0] == video[0] %}
                        <div class="d-flex bg-primary bg-opacity-10 rounded p-2 border border-primary border-opacity-50" style="transition: all 0.2s;">
                            <!-- Current Video Badge -->
                            <div class="position-absolute top-0 end-0 bg-primary text-white px-2 py-1 rounded-bottom-start" style="font-size: 0.7rem; font-weight: bold;">
                                <span data-i18n="video.nowPlaying">{{ translations.video.nowPlaying if translations.video else 'NOW PLAYING' }}</span>
                            </div>
                        {% else %}
                        <a href="{{ url_for('video_detail', video_id=top_video[0]) }}" class="text-decoration-none">
                            <div class="d-flex bg-light rounded p-2 hover-shadow" style="transition: all 0.2s;">
                        {% endif %}
                                <!-- Video Thumbnail -->
                                <div class="position-relative me-3" style="min-width: 120px; width: 120px; height: 68px; overflow: hidden; border-radius: 8px; background: #f8f9fa;">
                                    <video class="w-100 h-100" style="object-fit: cover;" muted preload="metadata">
                                        <source src="{{ get_video_url(top_video[2]) }}" type="video/mp4">
                                    </video>
                                    <!-- Vote Badge -->
                                    <div class="position-absolute bottom-0 end-0 bg-primary text-white px-1 rounded-start" style="font-size: 0.7rem;">
                                        <i class="fas fa-thumbs-up"></i> {{ top_video[3] if top_video[3] is not none else 0 }}
                                    </div>
                                    <!-- Rank Badge -->
                                    {% if loop.index <= 3 %}
                                    <div class="position-absolute top-0 start-0 px-1 rounded-end" 
                                         style="background: {% if loop.index == 1 %}#ffd700{% elif loop.index == 2 %}#c0c0c0{% else %}#cd7f32{% endif %}; color: {% if loop.index <= 2 %}#000{% else %}#fff{% endif %}; font-size: 0.7rem; font-weight: bold;">
                                        #{{ loop.index }}
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <!-- Video Info -->
                                <div class="flex-grow-1 min-w-0">
                                    <h6 class="mb-1 text-dark lh-sm" style="font-size: 0.9rem; display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                                        {{ top_video[1] }}
                                    </h6>
                                    <div class="d-flex align-items-center mb-1">
                                        {% if top_video[6] %}
                                        <img src="{{ url_for('static', filename='avatars/' + top_video[6]) }}" 
                                             alt="{{ top_video[5] }}'s profile picture" 
                                             class="rounded-circle me-2" 
                                             style="width: 20px; height: 20px; object-fit: cover; border: 1px solid #dee2e6;">
                                        {% else %}
                                        <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-2" 
                                             style="width: 20px; height: 20px; font-size: 0.7rem;">
                                            <i class="fas fa-user text-white"></i>
                                        </div>
                                        {% endif %}
                                        <small>
                                            <a href="{{ url_for('profile', username=top_video[5]) }}" class="text-decoration-none text-muted">
                                                {{ top_video[5] }}
                                            </a>
                                        </small>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <small class="text-muted">{{ top_video[3] }} <span data-i18n="video.votes">{{ translations.video.votes if translations.video else 'votes' }}</span></small>
                                        <small class="text-muted" data-i18n="video.uploaded">{{ translations.video.uploaded if translations.video else 'Uploaded' }}</small>
                                    </div>
                                </div>
                            </div>
                        {% if top_video[0] == video[0] %}
                        </div>
                        {% else %}
                        </a>
                        {% endif %}
                        {% endfor %}
                    </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-video-slash text-muted display-6 mb-3"></i>
                            <p class="text-muted" data-i18n="video.noVideosWithVotes">{{ translations.video.noVideosWithVotes if translations.video else 'No videos with votes yet' }}</p>
                            <small class="text-muted" data-i18n="video.videosAppearHere">{{ translations.video.videosAppearHere if translations.video else 'Videos will appear here once they receive votes!' }}</small>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Enhanced Navigation Card -->
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-light border-0 py-3">
                        <h6 class="mb-0 text-muted">
                            <i class="fas fa-compass me-2"></i><span data-i18n="common.navigation">{{ translations.common.navigation if translations.common else 'Navigation' }}</span>
                        </h6>
                    </div>
                    <div class="card-body p-3">
                        <div class="d-grid gap-2">
                            <a href="{{ url_for('videos') }}" class="btn btn-outline-primary rounded-pill">
                                <i class="fas fa-arrow-left me-2"></i><span data-i18n="video.backToVideos">{{ translations.video.backToVideos if translations.video else 'Back to Videos' }}</span>
                            </a>
                            <a href="{{ url_for('videos', sort='votes') }}" class="btn btn-outline-primary rounded-pill">
                                <i class="fas fa-trophy me-2"></i><span data-i18n="video.viewTopVideos">{{ translations.video.viewTopVideos if translations.video else 'View Top Videos' }}</span>
                            </a>
                            {% if session.user_id == video[1] %}
                            <a href="{{ url_for('dashboard') }}" class="btn btn-outline-success rounded-pill">
                                <i class="fas fa-tachometer-alt me-2"></i><span data-i18n="dashboard.myDashboard">{{ translations.dashboard.myDashboard if translations.dashboard else 'My Dashboard' }}</span>
                            </a>
                            {% endif %}
                            {% if session.user_id %}
                            <a href="{{ url_for('upload_video') }}" class="btn btn-primary rounded-pill">
                                <i class="fas fa-cloud-upload-alt me-2"></i><span data-i18n="nav.uploadVideo">{{ translations.nav.uploadVideo if translations.nav else 'Upload Video' }}</span>
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Simple vote functionality
document.addEventListener('DOMContentLoaded', function() {
    const voteBtn = document.getElementById('voteBtn');
    if (voteBtn) {
        voteBtn.addEventListener('click', function() {
            const videoId = this.dataset.videoId;
            
            // Disable button during request
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
            
            fetch('/vote', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `video_id=${videoId}`
            })
            .then(response => response.json())
            .then(data => {
                // Re-enable button
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-vote-yea me-2"></i>Vote for This Video';
                
                if (data.success) {
                    // Show success toast
                    const toast = document.createElement('div');
                    toast.className = 'toast align-items-center text-white bg-success border-0 show';
                    toast.style.cssText = `
                        position: fixed;
                        top: 80px;
                        right: 20px;
                        z-index: 1060;
                        min-width: 350px;
                        max-width: 400px;
                        border-radius: 10px;
                        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
                        animation: slideInRight 0.4s ease-out;
                    `;
                    
                    toast.innerHTML = `
                        <div class="d-flex">
                            <div class="toast-body">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-check-circle me-2 text-white" style="font-size: 1.1em;"></i>
                                    <strong>Vote Cast Successfully!</strong>
                                </div>
                                <div class="mb-2">
                                    This video now has <strong>${data.total_votes} votes</strong>
                                </div>
                                <div class="mt-2">
                                    <a href="/videos?sort=votes" class="btn btn-sm btn-light text-success fw-bold">
                                        <i class="fas fa-trophy me-1"></i> View Top Videos
                                    </a>
                                </div>
                            </div>
                            <button type="button" class="btn-close btn-close-white me-2 m-auto" onclick="this.parentElement.parentElement.remove()"></button>
                        </div>
                    `;
                    
                    document.body.appendChild(toast);
                    
                    // Auto-remove toast after 5 seconds
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.remove();
                        }
                    }, 5000);
                    
                    // Reload page to show updated vote count
                    setTimeout(() => location.reload(), 2000);
                    
                } else if (data.requires_voting_fee) {
                    // Redirect to payment page for this specific video
                    window.location.href = data.redirect_url || `/pay_voting_fee/${data.video_id || videoId}`;
                } else if (data.already_voted) {
                    // Show already voted message
                    alert('You have already voted on this video!');
                } else {
                    // Show error message
                    alert(data.message || 'An error occurred while voting');
                }
            })
            .catch(error => {
                // Re-enable button on error
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-vote-yea me-2"></i>Vote for This Video';
                alert('Network error. Please try again.');
            });
        });
    }
});

// Star Rating System
document.addEventListener('DOMContentLoaded', function() {
    const starRating = document.querySelector('.star-rating');
    const ratingMessage = document.getElementById('rating-message');
    const ratingContainer = document.querySelector('.rating-container');
    
    if (starRating) {
        const stars = starRating.querySelectorAll('.star');
        const videoId = starRating.dataset.videoId;
        let currentRating = 0;
        let hasRated = false;
        
        // Initialize rating interface
        initializeRatingInterface(videoId);
        
        // Star hover effects - always allow interaction
        stars.forEach((star, index) => {
            star.addEventListener('mouseenter', function() {
                highlightStars(index + 1);
                updateRatingMessage(index + 1);
            });
            
            star.addEventListener('mouseleave', function() {
                // Restore current rating display
                highlightStars(currentRating);
                if (currentRating === 0) {
                    ratingMessage.textContent = t('video.clickToRate') || 'Click a star to rate';
                } else {
                    ratingMessage.innerHTML = `<i class="fas fa-star text-warning me-1"></i>${t('video.yourRating') || 'Your rating'}: ${currentRating} ${t('rating.stars') || 'stars'} (${t('video.clickToChange') || 'click to change'})`;
                }
            });
            
            star.addEventListener('click', function() {
                const rating = index + 1;
                submitRating(videoId, rating);
                
                // Add animation to clicked star
                star.classList.add('animate');
                setTimeout(() => star.classList.remove('animate'), 300);
            });
        });
        
        function highlightStars(rating) {
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.add('filled');
                    star.classList.add('active');
                } else {
                    star.classList.remove('filled');
                    star.classList.remove('active');
                }
            });
        }
        
        function updateRatingMessage(rating) {
            const messages = {
                1: t('rating.poor') || 'Poor - 1 star',
                2: t('rating.fair') || 'Fair - 2 stars',
                3: t('rating.good') || 'Good - 3 stars',
                4: t('rating.veryGood') || 'Very Good - 4 stars',
                5: t('rating.excellent') || 'Excellent - 5 stars'
            };
            ratingMessage.textContent = messages[rating] || t('video.clickToRate') || 'Click a star to rate';
        }
        
        function initializeRatingInterface(videoId) {
            // Set initial state
            currentRating = 0;
            hasRated = false;
            ratingMessage.textContent = t('video.clickToRate') || 'Click a star to rate';
            highlightStars(0);
            
            // Check if user already rated this video
            fetch(`/get_user_rating/${videoId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.rating) {
                        // User has already rated - but can update rating
                        currentRating = data.rating;
                        highlightStars(currentRating);
                        ratingMessage.innerHTML = `<i class="fas fa-star text-warning me-1"></i>${t('video.yourRating') || 'Your rating'}: ${currentRating} ${t('rating.stars') || 'stars'} (${t('video.clickToChange') || 'click to change'})`;
                        
                        // Keep stars interactive so user can update rating
                        stars.forEach(star => {
                            star.classList.add('active');
                        });
                    } else {
                        // No existing rating - user can rate
                        ratingMessage.textContent = t('video.clickToRate') || 'Click a star to rate';
                    }
                })
                .catch(error => {
                    console.log('No existing rating found - user can rate');
                    ratingMessage.textContent = t('video.clickToRate') || 'Click a star to rate';
                });
        }
        
        function submitRating(videoId, rating) {
            // Disable interaction during submission
            stars.forEach(star => star.style.pointerEvents = 'none');
            ratingMessage.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>${t('rating.submittingRating') || 'Submitting rating...'}`;
            
            fetch('/submit_rating', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    video_id: videoId,
                    rating: rating
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const oldRating = currentRating;
                    currentRating = rating;
                    highlightStars(rating);
                    
                    // Show appropriate message based on whether it's an update or new rating
                    if (data.is_update) {
                        ratingMessage.innerHTML = `<i class="fas fa-check-circle text-success me-1"></i>${t('rating.ratingUpdated') || 'Rating updated from'} ${data.old_rating} ${t('rating.to') || 'to'} ${rating} ${t('rating.stars') || 'stars'}! (${t('video.clickToChange') || 'click to change again'})`;
                    } else {
                        ratingMessage.innerHTML = `<i class="fas fa-check-circle text-success me-1"></i>${t('rating.ratingSubmitted') || 'Thank you! You rated this video'} ${rating} ${t('rating.stars') || 'stars'} (${t('video.clickToChange') || 'click to change'})`;
                    }
                    
                    // Add success animation
                    ratingContainer.classList.add('success');
                    setTimeout(() => ratingContainer.classList.remove('success'), 1000);
                    
                    // Update page stats if available
                    if (data.new_average) {
                        updateRatingDisplay(data.new_average, data.total_votes || 0);
                    }
                    
                    // Show success toast
                    showRatingToast(data.message, 'success');
                    
                    // Keep stars interactive for future updates
                    stars.forEach(star => {
                        star.style.pointerEvents = 'auto';
                        star.style.cursor = 'pointer';
                        star.classList.add('active');
                    });
                    
                } else {
                    ratingMessage.innerHTML = `<i class="fas fa-times-circle text-danger me-1"></i>${data.message || (t('messages.error') || 'Rating failed')}`;
                    showRatingToast(data.message || (t('messages.error') || 'Rating failed. Please try again.'), 'error');
                    
                    // Re-enable interaction
                    stars.forEach(star => star.style.pointerEvents = 'auto');
                }
            })
            .catch(error => {
                console.error('Rating error:', error);
                ratingMessage.innerHTML = `<i class="fas fa-times-circle text-danger me-1"></i>${t('rating.networkError') || 'Network error. Please try again.'}`;
                showRatingToast(t('rating.networkError') || 'Network error. Please try again.', 'error');
                
                // Re-enable interaction
                stars.forEach(star => star.style.pointerEvents = 'auto');
            });
        }
        
        function updateRatingDisplay(newAverage, totalRatings) {
            // Update the current rating display if it exists
            const currentRatingEl = document.querySelector('.current-rating');
            if (currentRatingEl) {
                const avgStars = currentRatingEl.querySelector('.average-stars');
                const ratingText = currentRatingEl.querySelector('.text-muted');
                
                if (avgStars && ratingText) {
                    // Update star display
                    avgStars.innerHTML = '';
                    for (let i = 1; i <= 5; i++) {
                        const star = document.createElement('i');
                        if (i <= newAverage) {
                            star.className = 'fas fa-star text-warning';
                        } else if (i - 0.5 <= newAverage) {
                            star.className = 'fas fa-star-half-alt text-warning';
                        } else {
                            star.className = 'far fa-star text-muted';
                        }
                        avgStars.appendChild(star);
                    }
                    
                    // Update rating text
                    ratingText.innerHTML = `${newAverage.toFixed(1)} ${t('video.outOf5') || 'out of 5'} <small>(${totalRatings} ${t('video.ratings') || 'ratings'})</small>`;
                }
            }
        }
        
        function showRatingToast(message, type) {
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white ${type === 'success' ? 'bg-success' : 'bg-danger'} border-0 show`;
            toast.style.cssText = `
                position: fixed;
                top: 100px;
                right: 20px;
                z-index: 1060;
                min-width: 300px;
                border-radius: 10px;
                box-shadow: 0 8px 25px rgba(0,0,0,0.15);
                animation: slideInRight 0.4s ease-out;
            `;
            
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas ${type === 'success' ? 'fa-star' : 'fa-exclamation-triangle'} me-2"></i>
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" onclick="this.parentElement.parentElement.remove()"></button>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.style.animation = 'slideOutRight 0.4s ease-in';
                    setTimeout(() => toast.remove(), 400);
                }
            }, 5000);
        }
    }
});

// YouTube-style Comments System
document.addEventListener('DOMContentLoaded', function() {
    // Video overlay handling
    const video = document.querySelector('video');
    const overlay = document.querySelector('.video-overlay');
    
    if (video && overlay) {
        // Show overlay when video is paused/ended
        video.addEventListener('pause', function() {
            overlay.style.opacity = '1';
        });
        
        video.addEventListener('ended', function() {
            overlay.style.opacity = '1';
        });
        
        // Hide overlay when video is playing
        video.addEventListener('play', function() {
            overlay.style.opacity = '0';
        });
        
        // Hide overlay when video is loading/buffering
        video.addEventListener('loadstart', function() {
            overlay.style.opacity = '0';
        });
        
        // Click overlay to play video
        overlay.addEventListener('click', function() {
            if (video.paused) {
                video.play().catch(error => {
                    console.error('Error playing video:', error);
                    // Show user-friendly error message
                    const errorMsg = document.createElement('div');
                    errorMsg.className = 'alert alert-warning mt-2';
                    errorMsg.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Unable to play video. Please check if the video file exists and is in a supported format.';
                    video.parentElement.appendChild(errorMsg);
                });
            }
        });
        
        // Enable pointer events only when overlay is visible
        video.addEventListener('pause', function() {
            overlay.style.pointerEvents = 'auto';
        });
        
        video.addEventListener('play', function() {
            overlay.style.pointerEvents = 'none';
        });
        
        // Video error handling
        video.addEventListener('error', function(e) {
            console.error('Video error:', e);
            const errorMsg = document.createElement('div');
            errorMsg.className = 'alert alert-danger mt-2';
            errorMsg.innerHTML = `
                <h6><i class="fas fa-exclamation-circle me-2"></i>Video Error</h6>
                <p class="mb-1">Failed to load video: <code>{{ video[4] }}</code></p>
                <small class="text-muted">Error code: ${video.error ? video.error.code : 'Unknown'}</small>
                <br><small class="text-muted">Please ensure the video file exists in the uploads directory.</small>
            `;
            video.parentElement.appendChild(errorMsg);
        });
        
        // Log video path for debugging
        console.log('Video source:', video.currentSrc || video.src);
        console.log('Video ready state:', video.readyState);
    }
    
    // Navbar positioning
    const navbar = document.querySelector('.navbar');
    const sidebar = document.querySelector('.sticky-top');
    
    if (navbar && sidebar) {
        function updateStickyPosition() {
            const navbarHeight = navbar.offsetHeight;
            sidebar.style.top = (navbarHeight + 10) + 'px';
        }
        
        updateStickyPosition();
        window.addEventListener('resize', updateStickyPosition);
        
        function handleResponsive() {
            if (window.innerWidth < 992) {
                sidebar.style.position = 'relative';
                sidebar.style.top = 'auto';
            } else {
                sidebar.style.position = 'sticky';
                updateStickyPosition();
            }
        }
        
        handleResponsive();
        window.addEventListener('resize', handleResponsive);
    }
    
    // Main comment form handling
    const mainCommentInput = document.getElementById('main-comment-input');
    const commentActions = document.getElementById('comment-actions');
    const mainCommentForm = document.getElementById('main-comment-form');
    const cancelComment = document.getElementById('cancel-comment');
    
    if (mainCommentInput) {
        // Show comment actions when user focuses on input
        mainCommentInput.addEventListener('focus', function() {
            this.rows = 3;
            commentActions.classList.remove('d-none');
            commentActions.classList.add('d-flex');
            updateCommentButton();
        });

        // Enable/disable comment button based on input content
        mainCommentInput.addEventListener('input', function() {
            updateCommentButton();
        });

        // Handle keyboard shortcuts (Enter to submit, Shift+Enter for new line)
        mainCommentInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (mainCommentInput.value.trim() && !document.getElementById('submit-comment').disabled) {
                    mainCommentForm.dispatchEvent(new Event('submit'));
                }
            }
        });

        // Handle cancel button
        cancelComment.addEventListener('click', function() {
            mainCommentInput.rows = 1;
            mainCommentInput.value = '';
            commentActions.classList.add('d-none');
            commentActions.classList.remove('d-flex');
            mainCommentInput.blur();
            updateCommentButton();
        });

        // Function to enable/disable comment button
        function updateCommentButton() {
            const submitBtn = document.getElementById('submit-comment');
            const hasContent = mainCommentInput.value.trim().length > 0;
            
            if (submitBtn) {
                submitBtn.disabled = !hasContent;
                if (hasContent) {
                    submitBtn.classList.remove('btn-outline-primary');
                    submitBtn.classList.add('btn-primary');
                } else {
                    submitBtn.classList.remove('btn-primary');
                    submitBtn.classList.add('btn-outline-primary');
                }
            }
        }
        
        // Submit main comment
        mainCommentForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const commentText = mainCommentInput.value.trim();
            const videoId = document.getElementById('submit-comment').dataset.videoId;
            
            if (!commentText) return;
            
            fetch('/add_comment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `video_id=${videoId}&comment=${encodeURIComponent(commentText)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addCommentToDOM(data.comment, false);
                    mainCommentInput.value = '';
                    cancelComment.click();
                    
                    // Hide "no comments" message
                    const noComments = document.getElementById('no-comments');
                    if (noComments) noComments.style.display = 'none';
                    
                    // Update comment count
                    updateCommentCount(1);
                    
                    // Show success feedback
                    showNotification('Comment added successfully!', 'success');
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error adding comment');
            });
        });
    }
    
    // Reply button handlers
    document.addEventListener('click', function(e) {
        // Show/hide reply form
        if (e.target.closest('.reply-btn')) {
            const commentId = e.target.closest('.reply-btn').dataset.commentId;
            const replyForm = document.querySelector(`.reply-form[data-comment-id="${commentId}"]`);
            if (replyForm) {
                replyForm.style.display = replyForm.style.display === 'none' ? 'block' : 'none';
                if (replyForm.style.display === 'block') {
                    replyForm.querySelector('.reply-input').focus();
                }
            }
        }
        
        // Cancel reply
        if (e.target.closest('.cancel-reply')) {
            const replyForm = e.target.closest('.reply-form');
            replyForm.style.display = 'none';
            replyForm.querySelector('.reply-input').value = '';
        }
        
        // Submit reply
        if (e.target.closest('.submit-reply')) {
            e.preventDefault();
            const btn = e.target.closest('.submit-reply');
            const replyForm = btn.closest('.reply-form');
            const replyText = replyForm.querySelector('.reply-input').value.trim();
            const videoId = btn.dataset.videoId;
            const parentId = btn.dataset.parentId;
            
            if (!replyText) return;
            
            // Disable button during submission
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Replying...';
            
            fetch('/add_comment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `video_id=${videoId}&comment=${encodeURIComponent(replyText)}&parent_id=${parentId}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addCommentToDOM(data.comment, true, parentId);
                    replyForm.querySelector('.reply-input').value = '';
                    replyForm.style.display = 'none';
                    
                    // Update reply count and show replies button
                    updateReplyCount(parentId, 1);
                    
                    // Show success feedback
                    showNotification('Reply added successfully!', 'success');
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error adding reply');
            })
            .finally(() => {
                // Re-enable button
                btn.disabled = false;
                btn.innerHTML = 'Reply';
            });
        }
    });

    // Handle keyboard shortcuts for reply inputs
    document.addEventListener('keydown', function(e) {
        if (e.target.classList.contains('reply-input')) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (e.target.value.trim()) {
                    const submitBtn = e.target.closest('.reply-form').querySelector('.submit-reply');
                    submitBtn.click();
                }
            }
            if (e.key === 'Escape') {
                const cancelBtn = e.target.closest('.reply-form').querySelector('.cancel-reply');
                cancelBtn.click();
            }
        }
    });

    // Handle toggle replies and like buttons
    document.addEventListener('click', function(e) {
        // Toggle replies dropdown
        if (e.target.closest('.toggle-replies')) {
            const btn = e.target.closest('.toggle-replies');
            const commentId = btn.dataset.commentId;
            const isExpanded = btn.dataset.expanded === 'true';
            const repliesContainer = document.querySelector(`.replies-container[data-comment-id="${commentId}"]`);
            const icon = btn.querySelector('i');
            const text = btn.querySelector('.reply-count-text');
            
            if (isExpanded) {
                // Collapse replies
                repliesContainer.style.display = 'none';
                icon.className = 'fas fa-chevron-down me-2';
                // Get reply count from text and format properly
                const replyCount = text.textContent.match(/\d+/)?.[0] || '0';
                text.textContent = `${replyCount} ${replyCount === '1' ? 'reply' : 'replies'}`;
                btn.dataset.expanded = 'false';
            } else {
                // Expand replies - load them if not already loaded
                if (repliesContainer.children.length === 0) {
                    // Load replies from server
                    fetch(`/get_replies/${commentId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            data.replies.forEach(reply => {
                                const replyHtml = createReplyHTML(reply);
                                repliesContainer.insertAdjacentHTML('beforeend', replyHtml);
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error loading replies:', error);
                    });
                }
                
                repliesContainer.style.display = 'block';
                icon.className = 'fas fa-chevron-up me-2';
                text.textContent = 'Hide replies';
                btn.dataset.expanded = 'true';
            }
        }
        
        // Like/Dislike handlers
        if (e.target.closest('.like-btn')) {
            const btn = e.target.closest('.like-btn');
            const commentId = btn.dataset.commentId;
            const isLiked = btn.dataset.liked === 'true';
            const action = isLiked ? 'unlike' : 'like';
            
            fetch('/like_comment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `comment_id=${commentId}&action=${action}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    btn.dataset.liked = data.user_liked;
                    btn.querySelector('.like-count').textContent = data.like_count;
                    const icon = btn.querySelector('i');
                    
                    if (data.user_liked) {
                        // Liked state - solid blue icon
                        icon.className = 'fas fa-thumbs-up me-1';
                        icon.style.color = '#0d6efd'; // Bootstrap primary blue
                        btn.classList.remove('btn-outline-secondary');
                        btn.classList.add('btn-outline-primary');
                    } else {
                        // Unliked state - regular gray icon
                        icon.className = 'far fa-thumbs-up me-1';
                        icon.style.color = '#6c757d'; // Bootstrap secondary gray
                        btn.classList.remove('btn-outline-primary');
                        btn.classList.add('btn-outline-secondary');
                    }
                    
                    // Update dislike button state (mutual exclusivity handled by backend)
                    const dislikeBtn = btn.parentElement.querySelector('.dislike-btn');
                    if (dislikeBtn) {
                        dislikeBtn.dataset.disliked = data.user_disliked;
                        const dislikeIcon = dislikeBtn.querySelector('i');
                        if (data.user_disliked) {
                            dislikeIcon.className = 'fas fa-thumbs-down';
                            dislikeIcon.style.color = '#dc3545';
                            dislikeBtn.classList.remove('btn-outline-secondary');
                            dislikeBtn.classList.add('btn-outline-danger');
                        } else {
                            dislikeIcon.className = 'far fa-thumbs-down';
                            dislikeIcon.style.color = '#6c757d';
                            dislikeBtn.classList.remove('btn-outline-danger');
                            dislikeBtn.classList.add('btn-outline-secondary');
                        }
                    }
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Revert button state on error
                const icon = btn.querySelector('i');
                icon.style.color = '#6c757d';
                icon.className = 'far fa-thumbs-up me-1';
            });
        }
        
        // Dislike button handler
        if (e.target.closest('.dislike-btn')) {
            const btn = e.target.closest('.dislike-btn');
            const commentId = btn.dataset.commentId;
            const isDisliked = btn.dataset.disliked === 'true';
            const action = isDisliked ? 'undislike' : 'dislike';
            
            fetch('/dislike_comment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `comment_id=${commentId}&action=${action}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    btn.dataset.disliked = data.user_disliked;
                    const icon = btn.querySelector('i');
                    
                    if (data.user_disliked) {
                        // Disliked state - solid red icon
                        icon.className = 'fas fa-thumbs-down';
                        icon.style.color = '#dc3545'; // Bootstrap danger red
                        btn.classList.remove('btn-outline-secondary');
                        btn.classList.add('btn-outline-danger');
                    } else {
                        // Not disliked state - regular gray icon
                        icon.className = 'far fa-thumbs-down';
                        icon.style.color = '#6c757d'; // Bootstrap secondary gray
                        btn.classList.remove('btn-outline-danger');
                        btn.classList.add('btn-outline-secondary');
                    }
                    
                    // Update like button state (mutual exclusivity handled by backend)
                    const likeBtn = btn.parentElement.querySelector('.like-btn');
                    if (likeBtn) {
                        likeBtn.dataset.liked = data.user_liked;
                        likeBtn.querySelector('.like-count').textContent = data.like_count;
                        const likeIcon = likeBtn.querySelector('i');
                        if (data.user_liked) {
                            likeIcon.className = 'fas fa-thumbs-up me-1';
                            likeIcon.style.color = '#0d6efd';
                            likeBtn.classList.remove('btn-outline-secondary');
                            likeBtn.classList.add('btn-outline-primary');
                        } else {
                            likeIcon.className = 'far fa-thumbs-up me-1';
                            likeIcon.style.color = '#6c757d';
                            likeBtn.classList.remove('btn-outline-primary');
                            likeBtn.classList.add('btn-outline-secondary');
                        }
                    }
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Revert button state on error
                const icon = btn.querySelector('i');
                icon.style.color = '#6c757d';
                icon.className = 'far fa-thumbs-down';
            });
        }
    });
    
    // Function to add comment to DOM
    function addCommentToDOM(comment, isReply, parentId) {
        const container = isReply ? 
            document.querySelector(`.replies-container[data-comment-id="${parentId}"]`) :
            document.getElementById('comments-container');
        
        const commentHtml = isReply ? createReplyHTML(comment) : createCommentHTML(comment);
        
        if (isReply) {
            container.insertAdjacentHTML('beforeend', commentHtml);
            // Show replies container if it was hidden
            if (container.style.display === 'none') {
                container.style.display = 'block';
                // Update toggle button state
                const toggleBtn = document.querySelector(`.toggle-replies[data-comment-id="${parentId}"]`);
                if (toggleBtn) {
                    toggleBtn.dataset.expanded = 'true';
                    toggleBtn.querySelector('i').className = 'fas fa-chevron-up me-1';
                    toggleBtn.querySelector('.reply-count-text').textContent = 'Hide replies';
                }
            }
        } else {
            const noComments = document.getElementById('no-comments');
            if (noComments) {
                container.insertAdjacentHTML('afterbegin', commentHtml);
            } else {
                container.insertAdjacentHTML('afterbegin', commentHtml);
            }
        }
    }
    
    // Function to update reply count
    function updateReplyCount(commentId, increment) {
        const showRepliesBtn = document.querySelector(`.show-replies-btn[data-comment-id="${commentId}"]`);
        let replyCountText = showRepliesBtn?.querySelector('.reply-count-text');
        
        if (showRepliesBtn) {
            if (!replyCountText) {
                // Create the show replies button if it doesn't exist
                const newBtn = `
                    <div class="show-replies-btn mt-2" data-comment-id="${commentId}">
                        <button class="btn btn-sm btn-link text-primary fw-bold p-0 toggle-replies d-flex align-items-center" data-comment-id="${commentId}" data-expanded="false" style="text-decoration: none;">
                            <i class="fas fa-chevron-down me-2"></i>
                            <span class="reply-count-text">1 reply</span>
                        </button>
                    </div>
                `;
                
                // Find the reply form and insert before it
                const commentThread = document.querySelector(`[data-comment-id="${commentId}"]`);
                const replyForm = commentThread.querySelector('.reply-form');
                replyForm.insertAdjacentHTML('beforebegin', newBtn);
                return;
            }
            
            const currentCount = parseInt(replyCountText.textContent.match(/\d+/)?.[0]) || 0;
            const newCount = currentCount + increment;
            
            replyCountText.textContent = `${newCount} ${newCount === 1 ? 'reply' : 'replies'}`;
            
            if (newCount > 0) {
                showRepliesBtn.style.display = 'block';
            } else {
                showRepliesBtn.style.display = 'none';
            }
        }
    }
    
    function createCommentHTML(comment) {
        const avatarHtml = comment.avatar 
            ? `<img src="/static/avatars/${comment.avatar}" alt="${comment.username}'s Avatar" class="rounded-circle shadow-sm border border-2 border-light" style="width: 40px; height: 40px; object-fit: cover;">`
            : `<div class="bg-primary rounded-circle d-flex align-items-center justify-content-center shadow-sm border border-2 border-light" style="width: 40px; height: 40px;"><i class="fas fa-user text-white"></i></div>`;
        
        return `
            <div class="comment-thread mb-4" data-comment-id="${comment.id}">
                <div class="d-flex comment-item">
                    <div class="flex-shrink-0 me-3">
                        ${avatarHtml}
                    </div>
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-1">
                            <h6 class="mb-0 me-2">${comment.username}</h6>
                            <small class="text-muted">${comment.date}</small>
                        </div>
                        <p class="mb-2">${comment.text}</p>
                        
                        <div class="comment-actions d-flex align-items-center gap-3">
                            <button class="btn btn-sm btn-outline-secondary like-btn" data-comment-id="${comment.id}" data-liked="false" title="Like">
                                <i class="far fa-thumbs-up me-1"></i>
                                <span class="like-count">0</span>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary dislike-btn" data-comment-id="${comment.id}" data-disliked="false" title="Dislike">
                                <i class="far fa-thumbs-down"></i>
                            </button>
                            <button class="btn btn-sm btn-link text-muted reply-btn" data-comment-id="${comment.id}">
                                <i class="fas fa-reply me-1"></i>Reply
                            </button>
                        </div>
                        
                        <div class="show-replies-btn mt-2" data-comment-id="${comment.id}" style="display: none;">
                            <button class="btn btn-sm btn-link text-primary fw-bold p-0 toggle-replies d-flex align-items-center" data-comment-id="${comment.id}" data-expanded="false" style="text-decoration: none;">
                                <i class="fas fa-chevron-down me-2"></i>
                                <span class="reply-count-text">0 replies</span>
                            </button>
                        </div>
                        
                        <div class="reply-form mt-3" style="display: none;" data-comment-id="${comment.id}">
                            <div class="d-flex">
                                <div class="me-2">
                                    <div class="bg-success rounded-circle d-flex align-items-center justify-content-center" 
                                         style="width: 32px; height: 32px;">
                                        <i class="fas fa-user text-white" style="font-size: 0.8rem;"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1">
                                    <textarea class="form-control border-0 border-bottom rounded-0 reply-input" 
                                              rows="2" placeholder="Add a reply..."></textarea>
                                    <div class="d-flex justify-content-end mt-2 gap-2">
                                        <button class="btn btn-sm btn-outline-secondary cancel-reply">Cancel</button>
                                        <button class="btn btn-sm btn-primary submit-reply" data-video-id="${document.getElementById('submit-comment').dataset.videoId}" data-parent-id="${comment.id}">Reply</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="replies-container mt-3" data-comment-id="${comment.id}" style="display: none;"></div>
                    </div>
                </div>
            </div>
        `;
    }
    
    function createReplyHTML(comment) {
        const avatarHtml = comment.avatar 
            ? `<img src="/static/avatars/${comment.avatar}" alt="${comment.username}'s Avatar" class="rounded-circle shadow-sm border border-2 border-light" style="width: 32px; height: 32px; object-fit: cover;">`
            : `<div class="bg-success rounded-circle d-flex align-items-center justify-content-center shadow-sm border border-2 border-light" style="width: 32px; height: 32px;"><i class="fas fa-user text-white" style="font-size: 0.8rem;"></i></div>`;
        
        return `
            <div class="d-flex comment-item mb-3 ms-4">
                <div class="flex-shrink-0 me-3">
                    ${avatarHtml}
                </div>
                <div class="flex-grow-1">
                    <div class="d-flex align-items-center mb-1">
                        <h6 class="mb-0 me-2" style="font-size: 0.9rem;">${comment.username}</h6>
                        <small class="text-muted">${comment.date}</small>
                    </div>
                    <p class="mb-2" style="font-size: 0.9rem;">${comment.text}</p>
                    
                    <div class="comment-actions d-flex align-items-center gap-3">
                        <button class="btn btn-sm btn-outline-secondary like-btn" data-comment-id="${comment.id}" data-liked="false" title="Like">
                            <i class="far fa-thumbs-up me-1"></i>
                            <span class="like-count">0</span>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary dislike-btn" data-comment-id="${comment.id}" data-disliked="false" title="Dislike">
                            <i class="far fa-thumbs-down"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    // Function to update comment count
    function updateCommentCount(increment) {
        const commentBadge = document.querySelector('.badge.bg-light.text-dark');
        if (commentBadge) {
            const currentCount = parseInt(commentBadge.textContent) || 0;
            const newCount = currentCount + increment;
            commentBadge.textContent = newCount;
        }
    }

    // Star Rating System
    // Function to initialize the rating system
    function initRatingSystem() {
        const stars = document.querySelectorAll('.star-rating .star');
        const ratingContainer = document.querySelector('.rating-container');
        const ratingMessage = document.getElementById('rating-message');
        const videoId = document.querySelector('.star-rating').dataset.videoId;

        // Get user's current rating
        fetch(`/get_user_rating/${videoId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.rating) {
                    updateStarDisplay(data.rating);
                    ratingMessage.textContent = `Your rating: ${data.rating} stars`;
                }
            })
            .catch(error => console.error('Error:', error));

        // Star hover effects
        stars.forEach(star => {
            star.addEventListener('mouseover', function() {
                const rating = this.dataset.rating;
                updateStarDisplay(rating, true);
            });

            star.addEventListener('mouseout', function() {
                const currentRating = document.querySelector('.star.active');
                if (currentRating) {
                    updateStarDisplay(currentRating.dataset.rating);
                } else {
                    resetStars();
                }
            });

            // Star click handler
            star.addEventListener('click', function() {
                const rating = parseInt(this.dataset.rating);
                submitRating(videoId, rating);
            });
        });
    }

    // Function to submit rating
    function submitRating(videoId, rating) {
        // Add loading state
        const stars = document.querySelectorAll('.star-rating .star');
        stars.forEach(star => star.style.pointerEvents = 'none');
        const ratingMessage = document.getElementById('rating-message');
        ratingMessage.textContent = 'Submitting rating...';

        fetch('/submit_rating', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                video_id: videoId,
                rating: rating
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update the display
                updateStarDisplay(rating);
                
                // Show success message
                const ratingMessage = document.getElementById('rating-message');
                ratingMessage.textContent = data.message;
                
                // Update average rating display if it exists
                const avgStars = document.querySelector('.current-rating .average-stars');
                if (avgStars && data.new_average) {
                    updateAverageRatingDisplay(data.new_average);
                }
                
                // Animate the rating container
                const container = document.querySelector('.rating-container');
                container.classList.add('success');
                setTimeout(() => container.classList.remove('success'), 1000);
                
                // Show notification
                showNotification(data.message, 'success');
            } else {
                showNotification(data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error submitting rating', 'danger');
        });
    }

    // Function to update star display
    function updateStarDisplay(rating, isHover = false) {
        const stars = document.querySelectorAll('.star-rating .star');
        stars.forEach(star => {
            const starRating = parseInt(star.dataset.rating);
            if (starRating <= rating) {
                star.classList.add(isHover ? 'filled' : 'active');
                star.classList.remove(isHover ? 'active' : 'filled');
            } else {
                star.classList.remove('active', 'filled');
            }
        });
    }

    // Function to update average rating display
    function updateAverageRatingDisplay(avgRating) {
        const avgStarsContainer = document.querySelector('.current-rating .average-stars');
        if (avgStarsContainer) {
            avgStarsContainer.innerHTML = '';
            for (let i = 1; i <= 5; i++) {
                const star = document.createElement('i');
                if (i <= avgRating) {
                    star.className = 'fas fa-star text-warning';
                } else if (i - 0.5 <= avgRating) {
                    star.className = 'fas fa-star-half-alt text-warning';
                } else {
                    star.className = 'far fa-star text-muted';
                }
                avgStarsContainer.appendChild(star);
            }
            
            // Update the text display
            const ratingText = avgStarsContainer.nextElementSibling;
            if (ratingText) {
                const totalRatings = ratingText.querySelector('small')?.textContent.match(/\d+/)?.[0] || '0';
                ratingText.innerHTML = `${avgRating.toFixed(1)} out of 5 <small>(${totalRatings} ratings)</small>`;
            }
        }
    }

    // Function to reset stars
    function resetStars() {
        const stars = document.querySelectorAll('.star-rating .star');
        stars.forEach(star => star.classList.remove('active', 'filled'));
        const ratingMessage = document.getElementById('rating-message');
        if (ratingMessage) ratingMessage.textContent = 'Click a star to rate';
    }

    // Initialize when document is ready
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize rating system
        const stars = document.querySelectorAll('.star-rating .star');
        const ratingContainer = document.querySelector('.rating-container');
        const ratingMessage = document.getElementById('rating-message');
        const videoId = document.querySelector('.star-rating')?.dataset.videoId;

        if (videoId && stars.length > 0) {
            // Get user's current rating
            fetch(`/get_user_rating/${videoId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.rating) {
                        updateStarDisplay(data.rating);
                        ratingMessage.textContent = `Your rating: ${data.rating} stars`;
                    }
                })
                .catch(error => console.error('Error:', error));

            // Star hover effects
            stars.forEach(star => {
                star.addEventListener('mouseover', function() {
                    const rating = this.dataset.rating;
                    updateStarDisplay(rating, true);
                });

                star.addEventListener('mouseout', function() {
                    const currentRating = document.querySelector('.star.active');
                    if (currentRating) {
                        updateStarDisplay(currentRating.dataset.rating);
                    } else {
                        resetStars();
                    }
                });

                // Star click handler
                star.addEventListener('click', function() {
                    const rating = parseInt(this.dataset.rating);
                    if (rating) {
                        submitRating(videoId, rating);
                    }
                });
            });
        }
    });

    // Function to show notification
    function showNotification(message, type = 'info') {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `alert alert-${type === 'success' ? 'success' : 'info'} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(notification);
        
        // Auto remove after 3 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 3000);
    }


});

// Description expand/collapse functionality (YouTube-style)
function expandDescription() {
    document.querySelector('.description-content').classList.add('d-none');
    document.querySelector('.description-full').classList.remove('d-none');
}

function collapseDescription() {
    document.querySelector('.description-content').classList.remove('d-none');
    document.querySelector('.description-full').classList.add('d-none');
}

// Phone Voting Functionality for Video Detail Page
function copyVideoPhoneNumber() {
    const phoneNumber = "+2425537224";
    const videoTitle = "{{ video[2]|replace('\"', '\\\"') }}";
    
    // Copy to clipboard
    if (navigator.clipboard) {
        navigator.clipboard.writeText(phoneNumber).then(() => {
            showVideoPhoneNotification('Phone number copied! Call to vote for this video.');
        });
    } else {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = phoneNumber;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showVideoPhoneNotification('Phone number copied! Call to vote for this video.');
    }
    
    // Add visual feedback to the clicked element
    const phoneDisplay = document.querySelector('.phone-number-display');
    if (phoneDisplay) {
        phoneDisplay.style.transform = 'scale(0.95)';
        phoneDisplay.style.background = 'rgba(40, 167, 69, 0.15)';
        phoneDisplay.style.borderColor = 'rgba(40, 167, 69, 0.6)';
        setTimeout(() => {
            phoneDisplay.style.transform = 'scale(1)';
            phoneDisplay.style.background = 'rgba(255,255,255,0.15)';
            phoneDisplay.style.borderColor = 'rgba(255,255,255,0.3)';
        }, 300);
    }
}

function shareVideoForVoting() {
    const videoTitle = "{{ video[2]|replace('\"', '\\\"') }}";
    const videoUrl = window.location.href;
    const phoneNumber = "+2425537224";
    
    const shareText = `Vote for this video: "${videoTitle}" by calling ${phoneNumber} or visit: ${videoUrl}`;
    
    if (navigator.share) {
        navigator.share({
            title: `Vote for: ${videoTitle}`,
            text: shareText,
            url: videoUrl
        }).catch(console.error);
    } else {
        // Fallback: copy to clipboard
        if (navigator.clipboard) {
            navigator.clipboard.writeText(shareText).then(() => {
                showVideoPhoneNotification('Share link copied to clipboard!');
            });
        }
    }
}

// Auto-copy phone number when clicking to call (Video page specific)
function copyVideoPhoneNumberAuto(event) {
    const phoneNumber = "+2425537224";
    
    // Copy to clipboard automatically
    if (navigator.clipboard) {
        navigator.clipboard.writeText(phoneNumber).then(() => {
            showVideoPhoneNotification(t('video.phoneNumberCopied') || 'Phone number copied! Redirecting to call...');
        }).catch(() => {
            // Silent fail on copy, but still allow the call
        });
    } else {
        // Fallback for older browsers
        try {
            const textArea = document.createElement('textarea');
            textArea.value = phoneNumber;
            textArea.style.position = 'fixed';
            textArea.style.opacity = '0';
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            showVideoPhoneNotification(t('video.phoneNumberCopied') || 'Phone number copied! Redirecting to call...');
        } catch (err) {
            // Silent fail on copy, but still allow the call
        }
    }
    
    // Add visual feedback
    const phoneHero = event.currentTarget;
    if (phoneHero) {
        const card = phoneHero.querySelector('div');
        if (card) {
            card.style.transform = 'scale(0.95)';
            card.style.boxShadow = '0 2px 10px rgba(102, 126, 234, 0.5)';
            setTimeout(() => {
                card.style.transform = 'scale(1)';
                card.style.boxShadow = '0 4px 15px rgba(0,0,0,0.2)';
            }, 200);
        }
    }
    
    // Allow the link to proceed to tel:
    return true;
}

function showVideoPhoneNotification(message) {
    // Create notification element
    const notification = document.createElement('div');
    notification.innerHTML = `
        <i class="fas fa-check-circle me-2"></i>
        ${message}
    `;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 12px 20px;
        border-radius: 25px;
        font-weight: 600;
        z-index: 10000;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        animation: slideInFromRight 0.5s ease-out;
        font-size: 0.9rem;
        max-width: 320px;
        border: 2px solid rgba(255,215,0,0.3);
    `;
    
    document.body.appendChild(notification);
    
    // Remove notification after 4 seconds
    setTimeout(() => {
        notification.style.animation = 'slideOutToRight 0.5s ease-out';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 500);
    }, 4000);
}

// Add CSS animations for phone voting on video pages
const videoPhoneStyle = document.createElement('style');
videoPhoneStyle.textContent = `
    @keyframes slideInFromRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOutToRight {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
    
    @keyframes pulse {
        0%, 100% {
            transform: scale(1);
        }
        50% {
            transform: scale(1.05);
        }
    }
    
    @keyframes phoneGlow {
        0%, 100% {
            box-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
        }
        50% {
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.8), 0 0 30px rgba(255, 215, 0, 0.6);
        }
    }
    
    .phone-bg-animation {
        animation: pulse 4s ease-in-out infinite;
    }
    
    .phone-voting-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
    }
    
    .phone-voting-card:hover .phone-number-display {
        animation: phoneGlow 2s ease-in-out infinite;
    }
    
    .phone-action-buttons .btn {
        transition: all 0.3s ease;
    }
    
    .phone-action-buttons .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
`;
document.head.appendChild(videoPhoneStyle);
</script>
{% endblock %}
