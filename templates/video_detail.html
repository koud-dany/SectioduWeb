{% extends "base.html" %}

{% block title %}{{ video[2] }} - SectionduWeb{% endblock %}

{% block content %}
<style>
/* Fix for thumbs up icon visibility */
.like-btn i, .dislike-btn i {
    display: inline-block !important;
    opacity: 1 !important;
    visibility: visible !important;
    font-weight: normal !important;
    min-width: 16px;
    text-align: center;
}

.like-btn:hover i, .dislike-btn:hover i {
    transform: scale(1.1);
    transition: transform 0.2s ease;
}

/* Ensure proper icon states */
.like-btn[data-liked="true"] i {
    color: #0d6efd !important;
    font-weight: 900 !important;
}

.dislike-btn[data-disliked="true"] i {
    color: #dc3545 !important;
    font-weight: 900 !important;
}

.like-btn[data-liked="true"] {
    border-color: #0d6efd !important;
}

.dislike-btn[data-disliked="true"] {
    border-color: #dc3545 !important;
}

/* Comment action buttons styling */
.comment-actions .btn {
    border: 1px solid #dee2e6;
    background: transparent;
    transition: all 0.2s ease;
}

.comment-actions .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* YouTube-style video info styling */
.video-title {
    font-size: 1.25rem;
    font-weight: 600;
    line-height: 1.3;
    margin-bottom: 0.75rem;
}

.video-stats {
    font-size: 0.9rem;
    color: #606060;
}

.channel-info {
    border-bottom: 1px solid #e0e0e0;
    padding-bottom: 1rem;
    margin-bottom: 1rem;
}

.description-section {
    background-color: #f9f9f9;
    border-radius: 12px;
    padding: 1rem;
    font-size: 0.9rem;
    line-height: 1.5;
}
</style>

<div class="container-fluid py-4" style="max-width: 1280px; margin: 0 auto;">
    <div class="row g-4">
        <!-- Main Video Content (YouTube-style main column) -->
        <div class="col-lg-8 col-xl-9" style="padding-left: clamp(12px, 3vw, 24px); padding-right: clamp(12px, 3vw, 24px);">
            <!-- YouTube-Style Video Player -->
            <div class="mb-3">
                <div class="position-relative video-container" style="aspect-ratio: 16/9; max-width: 100%; background: #000; border-radius: 12px; overflow: hidden;">
                    <video class="w-100 h-100 shadow-lg" controls preload="metadata" style="object-fit: contain; border-radius: 12px;">
                        <source src="{{ get_video_url(video[4]) }}" type="video/mp4">
                        <source src="{{ get_video_url(video[4]) }}" type="video/webm">
                        <source src="{{ get_video_url(video[4]) }}" type="video/ogg">
                        <p class="text-center text-muted mt-3">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Your browser does not support the video tag or the video format.
                            <br><small>Supported formats: MP4, WebM, OGG</small>
                        </p>
                    </video>
                    <!-- Video overlay for better visual appeal (only shows when paused) -->
                    <div class="video-overlay position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center" style="border-radius: 12px; background: rgba(0,0,0,0.3); opacity: 0; transition: opacity 0.3s; pointer-events: none;">
                        <i class="fas fa-play-circle text-white" style="font-size: 3rem;"></i>
                    </div>
                </div>
            </div>
            
            <!-- Enhanced Video Info Card (YouTube-style) -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-body p-4">
                    <!-- Video Title (YouTube-style) -->
                    <h1 class="h3 fw-bold mb-3 text-dark">{{ video[2] }}</h1>
                    
                    <!-- Video Stats and Actions Row -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="d-flex align-items-center gap-3">
                            <span class="text-muted">
                                <i class="fas fa-eye me-1"></i>{{ video[14] if video[14] else 0 }} views
                                {% if not session.user_id %}
                                <small class="text-muted ms-2" title="Sign in to contribute to view counts">
                                    <i class="fas fa-info-circle"></i>
                                </small>
                                {% endif %}
                            </span>
                            <span class="text-muted">•</span>
                            <span class="text-muted">{{ video[5] }}</span>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <div class="d-flex align-items-center">
                                {% for i in range(5) %}
                                    {% if i < video[7]|round %}
                                    <i class="fas fa-star text-warning" style="font-size: 0.9rem;"></i>
                                    {% else %}
                                    <i class="far fa-star text-muted" style="font-size: 0.9rem;"></i>
                                    {% endif %}
                                {% endfor %}
                                <span class="ms-2 fw-semibold">{{ "%.1f"|format(video[7] if video[7] is not none else 0.0) }}</span>
                                <span class="text-muted ms-1">({{ video[6] }} votes)</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Channel Info (YouTube-style) -->
                    <div class="d-flex align-items-center mb-3 pb-3 border-bottom">
                        <div class="d-flex align-items-center flex-grow-1">
                            <div class="position-relative me-3">
                                {% if video[-1] %}
                                <img src="{{ url_for('static', filename='avatars/' + video[-1]) }}" 
                                     alt="{{ video[-2] }}'s Avatar" 
                                     class="rounded-circle shadow"
                                     style="width: 48px; height: 48px; object-fit: cover;">
                                {% else %}
                                <div class="bg-gradient bg-primary rounded-circle d-flex align-items-center justify-content-center shadow" 
                                     style="width: 48px; height: 48px;">
                                    <i class="fas fa-user text-white"></i>
                                </div>
                                {% endif %}
                                <span class="position-absolute bottom-0 end-0 bg-success rounded-circle border border-2 border-white" 
                                      style="width: 16px; height: 16px;" title="Verified Creator">
                                </span>
                            </div>
                            <div>
                                <h6 class="mb-0 fw-semibold">
                                    <a href="{{ url_for('profile', username=video[-2]) }}" class="text-decoration-none text-dark">
                                        {{ video[-2] }}
                                    </a>
                                </h6>
                                <small class="text-muted">Content Creator</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Description Section (YouTube-style expandable) -->
                    {% if video[3] %}
                    <div class="bg-light rounded-3 p-3">
                        <div class="description-content">
                            <p class="mb-2 lh-base">{{ video[3][:200] }}{% if video[3]|length > 200 %}...{% endif %}</p>
                            {% if video[3]|length > 200 %}
                            <button class="btn btn-link p-0 text-decoration-none fw-semibold" onclick="expandDescription()">
                                Show more
                            </button>
                            {% endif %}
                        </div>
                        <div class="description-full d-none">
                            <p class="mb-2 lh-base">{{ video[3] }}</p>
                            <button class="btn btn-link p-0 text-decoration-none fw-semibold" onclick="collapseDescription()">
                                Show less
                            </button>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Enhanced Comments Section -->
            <div class="card shadow-sm border-0 mt-4">
                <div class="card-header bg-gradient bg-primary text-white border-0 py-3">
                    <h5 class="mb-0">
                        <i class="fas fa-comments me-2"></i>
                        Comments 
                        <span class="badge bg-light text-dark ms-2">{{ comments|length }}</span>
                    </h5>
                </div>
                <div class="card-body p-4">
                    {% if session.user_id %}
                    <!-- YouTube-Style Comment Form -->
                    <form id="main-comment-form" class="mb-4">
                        <div class="d-flex">
                            <div class="me-3">
                                {% if current_user_avatar %}
                                <img src="{{ url_for('static', filename='avatars/' + current_user_avatar) }}" 
                                     alt="Your Avatar" 
                                     class="rounded-circle shadow-sm border border-2 border-light"
                                     style="width: 40px; height: 40px; object-fit: cover;">
                                {% else %}
                                <div class="bg-success rounded-circle d-flex align-items-center justify-content-center shadow-sm border border-2 border-light" 
                                     style="width: 40px; height: 40px;">
                                    <i class="fas fa-user text-white"></i>
                                </div>
                                {% endif %}
                            </div>
                            <div class="flex-grow-1">
                                <textarea class="form-control border-0 border-bottom rounded-0" id="main-comment-input" 
                                          rows="1" placeholder="Add a comment..." required
                                          style="resize: none; box-shadow: none;"></textarea>
                                <div class="d-flex justify-content-between align-items-center mt-2 d-none" id="comment-actions">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Be respectful and constructive
                                    </small>
                                    <div class="gap-2 d-flex">
                                        <button type="button" class="btn btn-sm btn-outline-secondary" id="cancel-comment">Cancel</button>
                                        <button type="submit" class="btn btn-sm btn-primary" id="submit-comment" data-video-id="{{ video[0] }}" disabled>
                                            <i class="fas fa-paper-plane me-1"></i>Comment
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                    <hr class="my-4">
                    {% endif %}
                    
                    <!-- YouTube-Style Comments -->
                    <div class="comment-section" id="comments-container">
                        {% for comment in comments %}
                        <div class="comment-thread mb-4" data-comment-id="{{ comment.id }}">
                            <!-- Main Comment -->
                            <div class="d-flex comment-item">
                                <div class="flex-shrink-0 me-3">
                                    {% if comment.avatar %}
                                    <img src="{{ url_for('static', filename='avatars/' + comment.avatar) }}" 
                                         alt="{{ comment.username }}'s Avatar" 
                                         class="rounded-circle shadow-sm border border-2 border-light"
                                         style="width: 40px; height: 40px; object-fit: cover;">
                                    {% else %}
                                    <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center shadow-sm border border-2 border-light" 
                                         style="width: 40px; height: 40px;">
                                        <i class="fas fa-user text-white"></i>
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center mb-1">
                                        <h6 class="mb-0 me-2">
                                            <a href="{{ url_for('profile', username=comment.username) }}" class="text-decoration-none text-dark">
                                                {{ comment.username }}
                                            </a>
                                        </h6>
                                        <small class="text-muted">{{ comment.date }}</small>
                                    </div>
                                    <p class="mb-2">{{ comment.text }}</p>
                                    
                                    <!-- Comment Actions (YouTube-style) -->
                                    <div class="comment-actions d-flex align-items-center gap-3">
                                        <button class="btn btn-sm btn-outline-secondary like-btn" data-comment-id="{{ comment.id }}" data-liked="{{ 'true' if comment.user_liked else 'false' }}" title="Like">
                                            <i class="{% if comment.user_liked %}fas fa-thumbs-up{% else %}far fa-thumbs-up{% endif %} me-1"></i>
                                            <span class="like-count">{{ comment.like_count }}</span>
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary dislike-btn" data-comment-id="{{ comment.id }}" data-disliked="{{ 'true' if comment.user_disliked else 'false' }}" title="Dislike">
                                            <i class="{% if comment.user_disliked %}fas fa-thumbs-down{% else %}far fa-thumbs-down{% endif %}"></i>
                                        </button>
                                        {% if session.user_id %}
                                        <button class="btn btn-sm btn-link text-muted reply-btn" data-comment-id="{{ comment.id }}">
                                            <i class="fas fa-reply me-1"></i>Reply
                                        </button>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Show Replies Button (YouTube-style) -->
                                    {% if comment.reply_count > 0 %}
                                    <div class="show-replies-btn mt-2" data-comment-id="{{ comment.id }}">
                                        <button class="btn btn-sm btn-link text-primary fw-bold p-0 toggle-replies d-flex align-items-center" data-comment-id="{{ comment.id }}" data-expanded="false" style="text-decoration: none;">
                                            <i class="fas fa-chevron-down me-2"></i>
                                            <span class="reply-count-text">{{ comment.reply_count }} replies</span>
                                        </button>
                                    </div>
                                    {% endif %}
                                    
                                    <!-- Reply Form (Hidden by default) -->
                                    {% if session.user_id %}
                                    <div class="reply-form mt-3" style="display: none;" data-comment-id="{{ comment.id }}">
                                        <div class="d-flex">
                                            <div class="me-2">
                                                <div class="bg-success rounded-circle d-flex align-items-center justify-content-center" 
                                                     style="width: 32px; height: 32px;">
                                                    <i class="fas fa-user text-white" style="font-size: 0.8rem;"></i>
                                                </div>
                                            </div>
                                            <div class="flex-grow-1">
                                                <textarea class="form-control border-0 border-bottom rounded-0 reply-input" 
                                                          rows="2" placeholder="Add a reply..."></textarea>
                                                <div class="d-flex justify-content-end mt-2 gap-2">
                                                    <button class="btn btn-sm btn-outline-secondary cancel-reply">Cancel</button>
                                                    <button class="btn btn-sm btn-primary submit-reply" data-video-id="{{ video[0] }}" data-parent-id="{{ comment.id }}">Reply</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                    
                                    <!-- Replies Container (Initially hidden) -->
                                    <div class="replies-container mt-3" data-comment-id="{{ comment.id }}" style="display: none;">
                                        <!-- Replies will be loaded here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        
                        {% if not comments %}
                        <div class="text-center py-5" id="no-comments">
                            <i class="fas fa-comment-slash text-muted display-4 mb-3"></i>
                            <h6 class="text-muted">No comments yet</h6>
                            <p class="text-muted">Be the first to share your thoughts about this video!</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Enhanced Voting Section -->
            {% if session.user_id %}
            <div class="card shadow-sm border-0 bg-warning bg-opacity-10 border-warning border-opacity-25 mb-4">
                <div class="card-body p-4 text-center">
                    <h5 class="card-title text-warning mb-3">
                        <i class="fas fa-trophy me-2"></i>Rate This Video
                    </h5>
                    <p class="text-muted mb-3">Help others discover great content by rating this video</p>
                    <div class="vote-stars d-flex justify-content-center gap-2 mb-3" data-video-id="{{ video[0] }}">
                        {% for i in range(5) %}
                        <i class="far fa-star vote-star" data-rating="{{ i + 1 }}" 
                           style="cursor: pointer; color: #ffc107; font-size: 2rem; transition: all 0.2s;"></i>
                        {% endfor %}
                    </div>
                    <small class="text-muted">
                        <i class="fas fa-mouse-pointer me-1"></i>Click on stars to rate (1-5 stars)
                    </small>
                </div>
            </div>
            {% else %}
            <div class="alert alert-info border-0 rounded-3">
                <h6 class="alert-heading">
                    <i class="fas fa-sign-in-alt me-2"></i>Join the Community
                </h6>
                <p class="mb-2">Sign in to rate videos and share your thoughts!</p>
                <a href="{{ url_for('login') }}" class="btn btn-primary btn-sm">
                    <i class="fas fa-user-plus me-1"></i>Sign In
                </a>
            </div>
            {% endif %}
        </div>
        
        <!-- Enhanced YouTube-Style Sidebar -->
        <div class="col-lg-4 col-xl-3" style="padding-left: clamp(12px, 2vw, 24px); padding-right: clamp(12px, 2vw, 24px);">
            <div class="sticky-top sidebar-scroll" style="top: 80px; z-index: 1020;">
                <!-- Top Rated Videos - Enhanced Card -->
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-header bg-gradient bg-warning text-dark border-0 py-3">
                        <h6 class="mb-0 fw-bold">
                            <i class="fas fa-trophy me-2"></i>Top Rated Videos
                        </h6>
                    </div>
                    <div class="card-body p-3">
                    
                    {% if top_videos %}
                    <div class="d-grid gap-2">
                        {% for top_video in top_videos %}
                        {% if top_video[0] == video[0] %}
                        <div class="d-flex bg-primary bg-opacity-10 rounded p-2 border border-primary border-opacity-50" style="transition: all 0.2s;">
                            <!-- Current Video Badge -->
                            <div class="position-absolute top-0 end-0 bg-primary text-white px-2 py-1 rounded-bottom-start" style="font-size: 0.7rem; font-weight: bold;">
                                NOW PLAYING
                            </div>
                        {% else %}
                        <a href="{{ url_for('video_detail', video_id=top_video[0]) }}" class="text-decoration-none">
                            <div class="d-flex bg-light rounded p-2 hover-shadow" style="transition: all 0.2s;">
                        {% endif %}
                                <!-- Video Thumbnail -->
                                <div class="position-relative me-3" style="min-width: 120px; width: 120px; height: 68px; overflow: hidden; border-radius: 8px; background: #f8f9fa;">
                                    <video class="w-100 h-100" style="object-fit: cover;" muted preload="metadata">
                                        <source src="{{ get_video_url(top_video[2]) }}" type="video/mp4">
                                    </video>
                                    <!-- Rating Badge -->
                                    <div class="position-absolute bottom-0 end-0 bg-dark text-white px-1 rounded-start" style="font-size: 0.7rem;">
                                        <i class="fas fa-star text-warning"></i> {{ "%.1f"|format(top_video[4] if top_video[4] is not none else 0.0) }}
                                    </div>
                                    <!-- Rank Badge -->
                                    {% if loop.index <= 3 %}
                                    <div class="position-absolute top-0 start-0 px-1 rounded-end" 
                                         style="background: {% if loop.index == 1 %}#ffd700{% elif loop.index == 2 %}#c0c0c0{% else %}#cd7f32{% endif %}; color: {% if loop.index <= 2 %}#000{% else %}#fff{% endif %}; font-size: 0.7rem; font-weight: bold;">
                                        #{{ loop.index }}
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <!-- Video Info -->
                                <div class="flex-grow-1 min-w-0">
                                    <h6 class="mb-1 text-dark lh-sm" style="font-size: 0.9rem; display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                                        {{ top_video[1] }}
                                    </h6>
                                    <div class="d-flex align-items-center mb-1">
                                        {% if top_video[6] %}
                                        <img src="{{ url_for('static', filename='avatars/' + top_video[6]) }}" 
                                             alt="{{ top_video[5] }}'s profile picture" 
                                             class="rounded-circle me-2" 
                                             style="width: 20px; height: 20px; object-fit: cover; border: 1px solid #dee2e6;">
                                        {% else %}
                                        <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-2" 
                                             style="width: 20px; height: 20px; font-size: 0.7rem;">
                                            <i class="fas fa-user text-white"></i>
                                        </div>
                                        {% endif %}
                                        <small>
                                            <a href="{{ url_for('profile', username=top_video[5]) }}" class="text-decoration-none text-muted">
                                                {{ top_video[5] }}
                                            </a>
                                        </small>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <small class="text-muted">{{ top_video[3] }} votes</small>
                                        <small class="text-muted">Uploaded</small>
                                    </div>
                                </div>
                            </div>
                        {% if top_video[0] == video[0] %}
                        </div>
                        {% else %}
                        </a>
                        {% endif %}
                        {% endfor %}
                    </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-video-slash text-muted display-6 mb-3"></i>
                            <p class="text-muted">No rated videos yet</p>
                            <small class="text-muted">Videos will appear here once they receive ratings!</small>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Enhanced Navigation Card -->
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-light border-0 py-3">
                        <h6 class="mb-0 text-muted">
                            <i class="fas fa-compass me-2"></i>Navigation
                        </h6>
                    </div>
                    <div class="card-body p-3">
                        <div class="d-grid gap-2">
                            <a href="{{ url_for('videos') }}" class="btn btn-outline-primary rounded-pill">
                                <i class="fas fa-arrow-left me-2"></i>Back to Videos
                            </a>
                            <a href="{{ url_for('videos', sort='top_rated') }}" class="btn btn-outline-warning rounded-pill">
                                <i class="fas fa-trophy me-2"></i>View All Top Rated
                            </a>
                            {% if session.user_id == video[1] %}
                            <a href="{{ url_for('dashboard') }}" class="btn btn-outline-success rounded-pill">
                                <i class="fas fa-tachometer-alt me-2"></i>My Dashboard
                            </a>
                            {% endif %}
                            {% if session.user_id %}
                            <a href="{{ url_for('upload_video') }}" class="btn btn-primary rounded-pill">
                                <i class="fas fa-cloud-upload-alt me-2"></i>Upload Video
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Star rating functionality
document.querySelectorAll('.vote-stars i').forEach(function(star, index) {
    star.addEventListener('mouseover', function() {
        const stars = this.parentElement.querySelectorAll('i');
        stars.forEach(function(s, i) {
            if (i <= index) {
                s.className = 'fas fa-star';
            } else {
                s.className = 'far fa-star';
            }
        });
    });
    
    star.addEventListener('click', function() {
        const rating = this.dataset.rating;
        const videoId = this.parentElement.dataset.videoId;
        
        fetch('/vote', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `video_id=${videoId}&rating=${rating}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show professional toast notification that doesn't affect layout
                const toast = document.createElement('div');
                toast.className = 'toast align-items-center text-white bg-success border-0 show';
                toast.style.cssText = `
                    position: fixed;
                    top: 80px;
                    right: 20px;
                    z-index: 1060;
                    min-width: 350px;
                    max-width: 400px;
                    border-radius: 10px;
                    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
                    animation: slideInRight 0.4s ease-out;
                `;
                toast.setAttribute('role', 'alert');
                toast.setAttribute('aria-live', 'assertive');
                toast.setAttribute('aria-atomic', 'true');
                
                toast.innerHTML = `
                    <div class="d-flex">
                        <div class="toast-body">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-check-circle me-2 text-white" style="font-size: 1.1em;"></i>
                                <strong>Vote Submitted!</strong>
                            </div>
                            <div class="mb-2">
                                You rated this video <strong>${data.user_rating} stars</strong>
                            </div>
                            <div class="mb-2">
                                <small><strong>Updated:</strong> ${data.average_rating.toFixed(1)} avg • ${data.total_votes} votes</small>
                            </div>
                            <div class="mt-2">
                                <a href="/videos?sort=top_rated" class="btn btn-sm btn-light text-success fw-bold">
                                    <i class="fas fa-trophy me-1"></i> View Top Rated
                                </a>
                            </div>
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" onclick="this.parentElement.parentElement.remove()"></button>
                    </div>
                `;
                
                // Add CSS animation for smooth entry
                if (!document.querySelector('#toast-animations')) {
                    const style = document.createElement('style');
                    style.id = 'toast-animations';
                    style.textContent = `
                        @keyframes slideInRight {
                            from {
                                transform: translateX(100%);
                                opacity: 0;
                            }
                            to {
                                transform: translateX(0);
                                opacity: 1;
                            }
                        }
                        @keyframes slideOutRight {
                            from {
                                transform: translateX(0);
                                opacity: 1;
                            }
                            to {
                                transform: translateX(100%);
                                opacity: 0;
                            }
                        }
                    `;
                    document.head.appendChild(style);
                }
                
                // Add toast to body (not container)
                document.body.appendChild(toast);
                
                // Auto-remove toast after 6 seconds with animation
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.style.animation = 'slideOutRight 0.4s ease-in forwards';
                        setTimeout(() => {
                            if (toast.parentNode) {
                                toast.remove();
                            }
                        }, 400);
                    }
                }, 6000);
                
                // Reload to show updated stats
                setTimeout(() => location.reload(), 2000);
            } else {
                alert(data.message);
            }
        });
    });
});

document.querySelector('.vote-stars').addEventListener('mouseleave', function() {
    const stars = this.querySelectorAll('i');
    stars.forEach(function(star) {
        star.className = 'far fa-star vote-star';
        star.style.fontSize = '2rem';
    });
});

// YouTube-style Comments System
document.addEventListener('DOMContentLoaded', function() {
    // Video overlay handling
    const video = document.querySelector('video');
    const overlay = document.querySelector('.video-overlay');
    
    if (video && overlay) {
        // Show overlay when video is paused/ended
        video.addEventListener('pause', function() {
            overlay.style.opacity = '1';
        });
        
        video.addEventListener('ended', function() {
            overlay.style.opacity = '1';
        });
        
        // Hide overlay when video is playing
        video.addEventListener('play', function() {
            overlay.style.opacity = '0';
        });
        
        // Hide overlay when video is loading/buffering
        video.addEventListener('loadstart', function() {
            overlay.style.opacity = '0';
        });
        
        // Click overlay to play video
        overlay.addEventListener('click', function() {
            if (video.paused) {
                video.play().catch(error => {
                    console.error('Error playing video:', error);
                    // Show user-friendly error message
                    const errorMsg = document.createElement('div');
                    errorMsg.className = 'alert alert-warning mt-2';
                    errorMsg.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Unable to play video. Please check if the video file exists and is in a supported format.';
                    video.parentElement.appendChild(errorMsg);
                });
            }
        });
        
        // Enable pointer events only when overlay is visible
        video.addEventListener('pause', function() {
            overlay.style.pointerEvents = 'auto';
        });
        
        video.addEventListener('play', function() {
            overlay.style.pointerEvents = 'none';
        });
        
        // Video error handling
        video.addEventListener('error', function(e) {
            console.error('Video error:', e);
            const errorMsg = document.createElement('div');
            errorMsg.className = 'alert alert-danger mt-2';
            errorMsg.innerHTML = `
                <h6><i class="fas fa-exclamation-circle me-2"></i>Video Error</h6>
                <p class="mb-1">Failed to load video: <code>{{ video[4] }}</code></p>
                <small class="text-muted">Error code: ${video.error ? video.error.code : 'Unknown'}</small>
                <br><small class="text-muted">Please ensure the video file exists in the uploads directory.</small>
            `;
            video.parentElement.appendChild(errorMsg);
        });
        
        // Log video path for debugging
        console.log('Video source:', video.currentSrc || video.src);
        console.log('Video ready state:', video.readyState);
    }
    
    // Navbar positioning
    const navbar = document.querySelector('.navbar');
    const sidebar = document.querySelector('.sticky-top');
    
    if (navbar && sidebar) {
        function updateStickyPosition() {
            const navbarHeight = navbar.offsetHeight;
            sidebar.style.top = (navbarHeight + 10) + 'px';
        }
        
        updateStickyPosition();
        window.addEventListener('resize', updateStickyPosition);
        
        function handleResponsive() {
            if (window.innerWidth < 992) {
                sidebar.style.position = 'relative';
                sidebar.style.top = 'auto';
            } else {
                sidebar.style.position = 'sticky';
                updateStickyPosition();
            }
        }
        
        handleResponsive();
        window.addEventListener('resize', handleResponsive);
    }
    
    // Main comment form handling
    const mainCommentInput = document.getElementById('main-comment-input');
    const commentActions = document.getElementById('comment-actions');
    const mainCommentForm = document.getElementById('main-comment-form');
    const cancelComment = document.getElementById('cancel-comment');
    
    if (mainCommentInput) {
        // Show comment actions when user focuses on input
        mainCommentInput.addEventListener('focus', function() {
            this.rows = 3;
            commentActions.classList.remove('d-none');
            commentActions.classList.add('d-flex');
            updateCommentButton();
        });

        // Enable/disable comment button based on input content
        mainCommentInput.addEventListener('input', function() {
            updateCommentButton();
        });

        // Handle keyboard shortcuts (Enter to submit, Shift+Enter for new line)
        mainCommentInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (mainCommentInput.value.trim() && !document.getElementById('submit-comment').disabled) {
                    mainCommentForm.dispatchEvent(new Event('submit'));
                }
            }
        });

        // Handle cancel button
        cancelComment.addEventListener('click', function() {
            mainCommentInput.rows = 1;
            mainCommentInput.value = '';
            commentActions.classList.add('d-none');
            commentActions.classList.remove('d-flex');
            mainCommentInput.blur();
            updateCommentButton();
        });

        // Function to enable/disable comment button
        function updateCommentButton() {
            const submitBtn = document.getElementById('submit-comment');
            const hasContent = mainCommentInput.value.trim().length > 0;
            
            if (submitBtn) {
                submitBtn.disabled = !hasContent;
                if (hasContent) {
                    submitBtn.classList.remove('btn-outline-primary');
                    submitBtn.classList.add('btn-primary');
                } else {
                    submitBtn.classList.remove('btn-primary');
                    submitBtn.classList.add('btn-outline-primary');
                }
            }
        }
        
        // Submit main comment
        mainCommentForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const commentText = mainCommentInput.value.trim();
            const videoId = document.getElementById('submit-comment').dataset.videoId;
            
            if (!commentText) return;
            
            fetch('/add_comment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `video_id=${videoId}&comment=${encodeURIComponent(commentText)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addCommentToDOM(data.comment, false);
                    mainCommentInput.value = '';
                    cancelComment.click();
                    
                    // Hide "no comments" message
                    const noComments = document.getElementById('no-comments');
                    if (noComments) noComments.style.display = 'none';
                    
                    // Update comment count
                    updateCommentCount(1);
                    
                    // Show success feedback
                    showNotification('Comment added successfully!', 'success');
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error adding comment');
            });
        });
    }
    
    // Reply button handlers
    document.addEventListener('click', function(e) {
        // Show/hide reply form
        if (e.target.closest('.reply-btn')) {
            const commentId = e.target.closest('.reply-btn').dataset.commentId;
            const replyForm = document.querySelector(`.reply-form[data-comment-id="${commentId}"]`);
            if (replyForm) {
                replyForm.style.display = replyForm.style.display === 'none' ? 'block' : 'none';
                if (replyForm.style.display === 'block') {
                    replyForm.querySelector('.reply-input').focus();
                }
            }
        }
        
        // Cancel reply
        if (e.target.closest('.cancel-reply')) {
            const replyForm = e.target.closest('.reply-form');
            replyForm.style.display = 'none';
            replyForm.querySelector('.reply-input').value = '';
        }
        
        // Submit reply
        if (e.target.closest('.submit-reply')) {
            e.preventDefault();
            const btn = e.target.closest('.submit-reply');
            const replyForm = btn.closest('.reply-form');
            const replyText = replyForm.querySelector('.reply-input').value.trim();
            const videoId = btn.dataset.videoId;
            const parentId = btn.dataset.parentId;
            
            if (!replyText) return;
            
            // Disable button during submission
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Replying...';
            
            fetch('/add_comment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `video_id=${videoId}&comment=${encodeURIComponent(replyText)}&parent_id=${parentId}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addCommentToDOM(data.comment, true, parentId);
                    replyForm.querySelector('.reply-input').value = '';
                    replyForm.style.display = 'none';
                    
                    // Update reply count and show replies button
                    updateReplyCount(parentId, 1);
                    
                    // Show success feedback
                    showNotification('Reply added successfully!', 'success');
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error adding reply');
            })
            .finally(() => {
                // Re-enable button
                btn.disabled = false;
                btn.innerHTML = 'Reply';
            });
        }
    });

    // Handle keyboard shortcuts for reply inputs
    document.addEventListener('keydown', function(e) {
        if (e.target.classList.contains('reply-input')) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (e.target.value.trim()) {
                    const submitBtn = e.target.closest('.reply-form').querySelector('.submit-reply');
                    submitBtn.click();
                }
            }
            if (e.key === 'Escape') {
                const cancelBtn = e.target.closest('.reply-form').querySelector('.cancel-reply');
                cancelBtn.click();
            }
        }
    });

    // Handle toggle replies and like buttons
    document.addEventListener('click', function(e) {
        // Toggle replies dropdown
        if (e.target.closest('.toggle-replies')) {
            const btn = e.target.closest('.toggle-replies');
            const commentId = btn.dataset.commentId;
            const isExpanded = btn.dataset.expanded === 'true';
            const repliesContainer = document.querySelector(`.replies-container[data-comment-id="${commentId}"]`);
            const icon = btn.querySelector('i');
            const text = btn.querySelector('.reply-count-text');
            
            if (isExpanded) {
                // Collapse replies
                repliesContainer.style.display = 'none';
                icon.className = 'fas fa-chevron-down me-2';
                // Get reply count from text and format properly
                const replyCount = text.textContent.match(/\d+/)?.[0] || '0';
                text.textContent = `${replyCount} ${replyCount === '1' ? 'reply' : 'replies'}`;
                btn.dataset.expanded = 'false';
            } else {
                // Expand replies - load them if not already loaded
                if (repliesContainer.children.length === 0) {
                    // Load replies from server
                    fetch(`/get_replies/${commentId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            data.replies.forEach(reply => {
                                const replyHtml = createReplyHTML(reply);
                                repliesContainer.insertAdjacentHTML('beforeend', replyHtml);
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error loading replies:', error);
                    });
                }
                
                repliesContainer.style.display = 'block';
                icon.className = 'fas fa-chevron-up me-2';
                text.textContent = 'Hide replies';
                btn.dataset.expanded = 'true';
            }
        }
        
        // Like/Dislike handlers
        if (e.target.closest('.like-btn')) {
            const btn = e.target.closest('.like-btn');
            const commentId = btn.dataset.commentId;
            const isLiked = btn.dataset.liked === 'true';
            const action = isLiked ? 'unlike' : 'like';
            
            fetch('/like_comment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `comment_id=${commentId}&action=${action}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    btn.dataset.liked = data.user_liked;
                    btn.querySelector('.like-count').textContent = data.like_count;
                    const icon = btn.querySelector('i');
                    
                    if (data.user_liked) {
                        // Liked state - solid blue icon
                        icon.className = 'fas fa-thumbs-up me-1';
                        icon.style.color = '#0d6efd'; // Bootstrap primary blue
                        btn.classList.remove('btn-outline-secondary');
                        btn.classList.add('btn-outline-primary');
                    } else {
                        // Unliked state - regular gray icon
                        icon.className = 'far fa-thumbs-up me-1';
                        icon.style.color = '#6c757d'; // Bootstrap secondary gray
                        btn.classList.remove('btn-outline-primary');
                        btn.classList.add('btn-outline-secondary');
                    }
                    
                    // Update dislike button state (mutual exclusivity handled by backend)
                    const dislikeBtn = btn.parentElement.querySelector('.dislike-btn');
                    if (dislikeBtn) {
                        dislikeBtn.dataset.disliked = data.user_disliked;
                        const dislikeIcon = dislikeBtn.querySelector('i');
                        if (data.user_disliked) {
                            dislikeIcon.className = 'fas fa-thumbs-down';
                            dislikeIcon.style.color = '#dc3545';
                            dislikeBtn.classList.remove('btn-outline-secondary');
                            dislikeBtn.classList.add('btn-outline-danger');
                        } else {
                            dislikeIcon.className = 'far fa-thumbs-down';
                            dislikeIcon.style.color = '#6c757d';
                            dislikeBtn.classList.remove('btn-outline-danger');
                            dislikeBtn.classList.add('btn-outline-secondary');
                        }
                    }
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Revert button state on error
                const icon = btn.querySelector('i');
                icon.style.color = '#6c757d';
                icon.className = 'far fa-thumbs-up me-1';
            });
        }
        
        // Dislike button handler
        if (e.target.closest('.dislike-btn')) {
            const btn = e.target.closest('.dislike-btn');
            const commentId = btn.dataset.commentId;
            const isDisliked = btn.dataset.disliked === 'true';
            const action = isDisliked ? 'undislike' : 'dislike';
            
            fetch('/dislike_comment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `comment_id=${commentId}&action=${action}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    btn.dataset.disliked = data.user_disliked;
                    const icon = btn.querySelector('i');
                    
                    if (data.user_disliked) {
                        // Disliked state - solid red icon
                        icon.className = 'fas fa-thumbs-down';
                        icon.style.color = '#dc3545'; // Bootstrap danger red
                        btn.classList.remove('btn-outline-secondary');
                        btn.classList.add('btn-outline-danger');
                    } else {
                        // Not disliked state - regular gray icon
                        icon.className = 'far fa-thumbs-down';
                        icon.style.color = '#6c757d'; // Bootstrap secondary gray
                        btn.classList.remove('btn-outline-danger');
                        btn.classList.add('btn-outline-secondary');
                    }
                    
                    // Update like button state (mutual exclusivity handled by backend)
                    const likeBtn = btn.parentElement.querySelector('.like-btn');
                    if (likeBtn) {
                        likeBtn.dataset.liked = data.user_liked;
                        likeBtn.querySelector('.like-count').textContent = data.like_count;
                        const likeIcon = likeBtn.querySelector('i');
                        if (data.user_liked) {
                            likeIcon.className = 'fas fa-thumbs-up me-1';
                            likeIcon.style.color = '#0d6efd';
                            likeBtn.classList.remove('btn-outline-secondary');
                            likeBtn.classList.add('btn-outline-primary');
                        } else {
                            likeIcon.className = 'far fa-thumbs-up me-1';
                            likeIcon.style.color = '#6c757d';
                            likeBtn.classList.remove('btn-outline-primary');
                            likeBtn.classList.add('btn-outline-secondary');
                        }
                    }
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Revert button state on error
                const icon = btn.querySelector('i');
                icon.style.color = '#6c757d';
                icon.className = 'far fa-thumbs-down';
            });
        }
    });
    
    // Function to add comment to DOM
    function addCommentToDOM(comment, isReply, parentId) {
        const container = isReply ? 
            document.querySelector(`.replies-container[data-comment-id="${parentId}"]`) :
            document.getElementById('comments-container');
        
        const commentHtml = isReply ? createReplyHTML(comment) : createCommentHTML(comment);
        
        if (isReply) {
            container.insertAdjacentHTML('beforeend', commentHtml);
            // Show replies container if it was hidden
            if (container.style.display === 'none') {
                container.style.display = 'block';
                // Update toggle button state
                const toggleBtn = document.querySelector(`.toggle-replies[data-comment-id="${parentId}"]`);
                if (toggleBtn) {
                    toggleBtn.dataset.expanded = 'true';
                    toggleBtn.querySelector('i').className = 'fas fa-chevron-up me-1';
                    toggleBtn.querySelector('.reply-count-text').textContent = 'Hide replies';
                }
            }
        } else {
            const noComments = document.getElementById('no-comments');
            if (noComments) {
                container.insertAdjacentHTML('afterbegin', commentHtml);
            } else {
                container.insertAdjacentHTML('afterbegin', commentHtml);
            }
        }
    }
    
    // Function to update reply count
    function updateReplyCount(commentId, increment) {
        const showRepliesBtn = document.querySelector(`.show-replies-btn[data-comment-id="${commentId}"]`);
        let replyCountText = showRepliesBtn?.querySelector('.reply-count-text');
        
        if (showRepliesBtn) {
            if (!replyCountText) {
                // Create the show replies button if it doesn't exist
                const newBtn = `
                    <div class="show-replies-btn mt-2" data-comment-id="${commentId}">
                        <button class="btn btn-sm btn-link text-primary fw-bold p-0 toggle-replies d-flex align-items-center" data-comment-id="${commentId}" data-expanded="false" style="text-decoration: none;">
                            <i class="fas fa-chevron-down me-2"></i>
                            <span class="reply-count-text">1 reply</span>
                        </button>
                    </div>
                `;
                
                // Find the reply form and insert before it
                const commentThread = document.querySelector(`[data-comment-id="${commentId}"]`);
                const replyForm = commentThread.querySelector('.reply-form');
                replyForm.insertAdjacentHTML('beforebegin', newBtn);
                return;
            }
            
            const currentCount = parseInt(replyCountText.textContent.match(/\d+/)?.[0]) || 0;
            const newCount = currentCount + increment;
            
            replyCountText.textContent = `${newCount} ${newCount === 1 ? 'reply' : 'replies'}`;
            
            if (newCount > 0) {
                showRepliesBtn.style.display = 'block';
            } else {
                showRepliesBtn.style.display = 'none';
            }
        }
    }
    
    function createCommentHTML(comment) {
        const avatarHtml = comment.avatar 
            ? `<img src="/static/avatars/${comment.avatar}" alt="${comment.username}'s Avatar" class="rounded-circle shadow-sm border border-2 border-light" style="width: 40px; height: 40px; object-fit: cover;">`
            : `<div class="bg-primary rounded-circle d-flex align-items-center justify-content-center shadow-sm border border-2 border-light" style="width: 40px; height: 40px;"><i class="fas fa-user text-white"></i></div>`;
        
        return `
            <div class="comment-thread mb-4" data-comment-id="${comment.id}">
                <div class="d-flex comment-item">
                    <div class="flex-shrink-0 me-3">
                        ${avatarHtml}
                    </div>
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-1">
                            <h6 class="mb-0 me-2">${comment.username}</h6>
                            <small class="text-muted">${comment.date}</small>
                        </div>
                        <p class="mb-2">${comment.text}</p>
                        
                        <div class="comment-actions d-flex align-items-center gap-3">
                            <button class="btn btn-sm btn-outline-secondary like-btn" data-comment-id="${comment.id}" data-liked="false" title="Like">
                                <i class="far fa-thumbs-up me-1"></i>
                                <span class="like-count">0</span>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary dislike-btn" data-comment-id="${comment.id}" data-disliked="false" title="Dislike">
                                <i class="far fa-thumbs-down"></i>
                            </button>
                            <button class="btn btn-sm btn-link text-muted reply-btn" data-comment-id="${comment.id}">
                                <i class="fas fa-reply me-1"></i>Reply
                            </button>
                        </div>
                        
                        <div class="show-replies-btn mt-2" data-comment-id="${comment.id}" style="display: none;">
                            <button class="btn btn-sm btn-link text-primary fw-bold p-0 toggle-replies d-flex align-items-center" data-comment-id="${comment.id}" data-expanded="false" style="text-decoration: none;">
                                <i class="fas fa-chevron-down me-2"></i>
                                <span class="reply-count-text">0 replies</span>
                            </button>
                        </div>
                        
                        <div class="reply-form mt-3" style="display: none;" data-comment-id="${comment.id}">
                            <div class="d-flex">
                                <div class="me-2">
                                    <div class="bg-success rounded-circle d-flex align-items-center justify-content-center" 
                                         style="width: 32px; height: 32px;">
                                        <i class="fas fa-user text-white" style="font-size: 0.8rem;"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1">
                                    <textarea class="form-control border-0 border-bottom rounded-0 reply-input" 
                                              rows="2" placeholder="Add a reply..."></textarea>
                                    <div class="d-flex justify-content-end mt-2 gap-2">
                                        <button class="btn btn-sm btn-outline-secondary cancel-reply">Cancel</button>
                                        <button class="btn btn-sm btn-primary submit-reply" data-video-id="${document.getElementById('submit-comment').dataset.videoId}" data-parent-id="${comment.id}">Reply</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="replies-container mt-3" data-comment-id="${comment.id}" style="display: none;"></div>
                    </div>
                </div>
            </div>
        `;
    }
    
    function createReplyHTML(comment) {
        const avatarHtml = comment.avatar 
            ? `<img src="/static/avatars/${comment.avatar}" alt="${comment.username}'s Avatar" class="rounded-circle shadow-sm border border-2 border-light" style="width: 32px; height: 32px; object-fit: cover;">`
            : `<div class="bg-success rounded-circle d-flex align-items-center justify-content-center shadow-sm border border-2 border-light" style="width: 32px; height: 32px;"><i class="fas fa-user text-white" style="font-size: 0.8rem;"></i></div>`;
        
        return `
            <div class="d-flex comment-item mb-3 ms-4">
                <div class="flex-shrink-0 me-3">
                    ${avatarHtml}
                </div>
                <div class="flex-grow-1">
                    <div class="d-flex align-items-center mb-1">
                        <h6 class="mb-0 me-2" style="font-size: 0.9rem;">${comment.username}</h6>
                        <small class="text-muted">${comment.date}</small>
                    </div>
                    <p class="mb-2" style="font-size: 0.9rem;">${comment.text}</p>
                    
                    <div class="comment-actions d-flex align-items-center gap-3">
                        <button class="btn btn-sm btn-outline-secondary like-btn" data-comment-id="${comment.id}" data-liked="false" title="Like">
                            <i class="far fa-thumbs-up me-1"></i>
                            <span class="like-count">0</span>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary dislike-btn" data-comment-id="${comment.id}" data-disliked="false" title="Dislike">
                            <i class="far fa-thumbs-down"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    // Function to update comment count
    function updateCommentCount(increment) {
        const commentBadge = document.querySelector('.badge.bg-light.text-dark');
        if (commentBadge) {
            const currentCount = parseInt(commentBadge.textContent) || 0;
            const newCount = currentCount + increment;
            commentBadge.textContent = newCount;
        }
    }

    // Function to show notification
    function showNotification(message, type = 'info') {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `alert alert-${type === 'success' ? 'success' : 'info'} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(notification);
        
        // Auto remove after 3 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 3000);
    }


});

// Description expand/collapse functionality (YouTube-style)
function expandDescription() {
    document.querySelector('.description-content').classList.add('d-none');
    document.querySelector('.description-full').classList.remove('d-none');
}

function collapseDescription() {
    document.querySelector('.description-content').classList.remove('d-none');
    document.querySelector('.description-full').classList.add('d-none');
}
</script>
{% endblock %}
